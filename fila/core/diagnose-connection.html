<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Connection Diagnostic – Cloudignite</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; max-width: 560px; margin: 2rem auto; padding: 0 1rem; }
    h1 { font-size: 1.25rem; margin-bottom: 1rem; }
    button { padding: 0.5rem 1rem; cursor: pointer; background: #0d6efd; color: #fff; border: none; border-radius: 6px; }
    button:hover { background: #0b5ed7; }
    #results { margin-top: 1rem; }
    .test { padding: 10px 12px; margin: 6px 0; border-radius: 6px; }
    .pass { background: #d4edda; color: #155724; }
    .fail { background: #f8d7da; color: #721c24; }
    .muted { color: #6c757d; font-size: 0.9rem; }
  </style>
</head>
<body>
  <h1>Frontend–Backend Connection Diagnostic</h1>
  <p class="muted">Checks backend reachability, CORS, and database. Use dev: frontend on :3000, backend on :8000.</p>
  <button type="button" id="run">Run diagnostics</button>
  <div id="results"></div>

  <script src="../assets/js/config.js"></script>
  <script>
    const API_BASE = (window.APP_CONFIG && window.APP_CONFIG.API_BASE_URL) || 'http://localhost:8000/api';
    const API_ORIGIN = API_BASE.replace(/\/api\/?$/, '');

    async function run() {
      const el = document.getElementById('results');
      el.innerHTML = '<p class="muted">Running…</p>';
      const results = [];

      try {
        const h = await fetch(API_ORIGIN + '/api/healthz');
        const ok = h.ok;
        results.push({ name: 'Backend reachable', ok, detail: ok ? '' : `Status ${h.status}` });
      } catch (e) {
        results.push({ name: 'Backend reachable', ok: false, detail: e.message });
      }

      try {
        await fetch(API_ORIGIN + '/api/healthz', { method: 'GET', credentials: 'include' });
        results.push({ name: 'CORS / fetch from this origin', ok: true, detail: '' });
      } catch (e) {
        results.push({ name: 'CORS / fetch from this origin', ok: false, detail: e.message });
      }

      try {
        const d = await fetch(API_ORIGIN + '/api/healthz?detailed=1').then(r => r.json());
        const dbOk = d && (d.database === 'connected' || d.database === true);
        results.push({ name: 'Database connected', ok: dbOk, detail: dbOk ? '' : (d.database || 'unknown') });
      } catch (e) {
        results.push({ name: 'Database connected', ok: false, detail: e.message });
      }

      el.innerHTML = results.map(r =>
        `<div class="test ${r.ok ? 'pass' : 'fail'}"><strong>${r.name}</strong> ${r.ok ? '✅ PASS' : '❌ FAIL'}${r.detail ? `<br><span class="muted">${r.detail}</span>` : ''}</div>`
      ).join('');
    }

    document.getElementById('run').addEventListener('click', run);
  </script>
</body>
</html>

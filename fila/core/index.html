<!DOCTYPE html>
<html lang="zxx">
    <head>
		<!-- Required meta tags -->
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

		<!-- Links Of CSS File -->
		<link rel="stylesheet" href="../assets/css/sidebar-menu.css">
		<link rel="stylesheet" href="../assets/css/simplebar.css">
		<link rel="stylesheet" href="../assets/css/prism.css">
        <link rel="stylesheet" href="../assets/css/quill.snow.css">
        <link rel="stylesheet" href="../assets/css/remixicon.css">
        <link rel="stylesheet" href="../assets/css/swiper-bundle.min.css">
        <link rel="stylesheet" href="../assets/css/jsvectormap.min.css">
		<link rel="stylesheet" href="../assets/css/style.css">
		
		<!-- Favicon -->
		<link rel="icon" type="image/png" href="../assets/images/favicon.png">
        
		<!-- Title -->
		<title>Restaurant Cost Control - Loss Detection Dashboard</title>
    </head>
    <body class="bg-body-bg">
        
        <!-- Start Preloader Area -->
        <div class="preloader" id="preloader">
            <div class="preloader">
                <div class="waviy position-relative">
                    <span class="d-inline-block">C</span>
                    <span class="d-inline-block">l</span>
                    <span class="d-inline-block">o</span>
                    <span class="d-inline-block">u</span>
                    <span class="d-inline-block">d</span>
                    <span class="d-inline-block">i</span>
                    <span class="d-inline-block">g</span>
                    <span class="d-inline-block">n</span>
                    <span class="d-inline-block">i</span>
                    <span class="d-inline-block">t</span>
                    <span class="d-inline-block">e</span>
                </div>
            </div>
        </div>
        <!-- End Preloader Area -->

        <!-- Start Sidebar Area -->
        <div class="sidebar-area" id="sidebar-area">
            <div class="logo position-relative d-flex align-items-center justify-content-between">
                <a href="index.html" class="d-block text-decoration-none position-relative">
                    <img src="../assets/images/logo-icon.png" alt="logo-icon">
                    <span class="logo-text text-secondary fw-semibold">Cloudignite</span>
                </a> 
                <button class="sidebar-burger-menu-close bg-transparent py-3 border-0 opacity-0 z-n1 position-absolute top-50 end-0 translate-middle-y" id="sidebar-burger-menu-close">
                    <span class="border-1 d-block for-dark-burger" style="border-bottom: 1px solid #475569; height: 1px; width: 25px; transform: rotate(45deg);"></span>
                    <span class="border-1 d-block for-dark-burger" style="border-bottom: 1px solid #475569; height: 1px; width: 25px; transform: rotate(-45deg);"></span>
                </button>
                <button class="sidebar-burger-menu bg-transparent p-0 border-0" id="sidebar-burger-menu">
                    <span class="border-1 d-block for-dark-burger" style="border-bottom: 1px solid #475569; height: 1px; width: 25px;"></span>
                    <span class="border-1 d-block for-dark-burger" style="border-bottom: 1px solid #475569; height: 1px; width: 25px; margin: 6px 0;"></span>
                    <span class="border-1 d-block for-dark-burger" style="border-bottom: 1px solid #475569; height: 1px; width: 25px;"></span>
                </button>
            </div>

            <aside id="layout-menu" class="layout-menu menu-vertical menu active" data-simplebar>
                <ul class="menu-inner">
                    <li class="menu-title small text-uppercase">
                        <span class="menu-title-text">Overview</span>
                    </li>
                    <li class="menu-item" id="nav-owner-view">
                        <a href="owner-view.html" class="menu-link">
                            <span class="material-symbols-outlined menu-icon">visibility</span>
                            <span class="title">Owner View</span>
                        </a>
                    </li>
                    <li class="menu-item open">
                        <a href="index.html" class="menu-link active">
                            <span class="material-symbols-outlined menu-icon">dashboard</span>
                            <span class="title">Loss Summary</span>
                        </a>
                    </li>

                    <li class="menu-title small text-uppercase mt-3">
                        <span class="menu-title-text">Inventory & Waste</span>
                    </li>
                    <li class="menu-item">
                        <a href="products-list.html" class="menu-link">
                            <span class="material-symbols-outlined menu-icon">inventory_2</span>
                            <span class="title">Inventory Control</span>
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="inventory-count.html" class="menu-link">
                            <span class="material-symbols-outlined menu-icon">fact_check</span>
                            <span class="title">Weekly Count</span>
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="analytics.html" class="menu-link">
                            <span class="material-symbols-outlined menu-icon">delete</span>
                            <span class="title">Waste Tracking</span>
                        </a>
                    </li>

                    <li class="menu-title small text-uppercase mt-3">
                        <span class="menu-title-text">Cost & Purchasing</span>
                    </li>
                    <li class="menu-item">
                        <a href="reports.html" class="menu-link">
                            <span class="material-symbols-outlined menu-icon">groups</span>
                            <span class="title">Labor Cost Analysis</span>
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="products-list.html" class="menu-link">
                            <span class="material-symbols-outlined menu-icon">restaurant_menu</span>
                            <span class="title">Menu Profitability</span>
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="invoices.html" class="menu-link">
                            <span class="material-symbols-outlined menu-icon">local_shipping</span>
                            <span class="title">Suppliers & Invoices</span>
                        </a>
                    </li>

                    <li class="menu-title small text-uppercase mt-3">
                        <span class="menu-title-text">Actions & Reports</span>
                    </li>
                    <li class="menu-item">
                        <a href="analytics.html" class="menu-link">
                            <span class="material-symbols-outlined menu-icon">task_alt</span>
                            <span class="title">Action Items</span>
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="manual-data-entry.html" class="menu-link">
                            <span class="material-symbols-outlined menu-icon">edit_note</span>
                            <span class="title">Manual Data Entry</span>
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="reports.html" class="menu-link">
                            <span class="material-symbols-outlined menu-icon">assessment</span>
                            <span class="title">Reports & Exports</span>
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="alerts.html" class="menu-link">
                            <span class="material-symbols-outlined menu-icon">notifications</span>
                            <span class="title">Alerts</span>
                        </a>
                    </li>

                    <li class="menu-title small text-uppercase mt-3">
                        <span class="menu-title-text">Settings</span>
                    </li>
                    <li class="menu-item">
                        <a href="javascript:void(0);" class="menu-link menu-toggle">
                            <span class="material-symbols-outlined menu-icon">settings</span>
                            <span class="title">Settings</span>
                        </a>
                        <ul class="menu-sub">
                            <li class="menu-item">
                                <a href="account-settings.html" class="menu-link">Account Settings</a>
                            </li>
                            <li class="menu-item">
                                <a href="change-password.html" class="menu-link">Change Password</a>
                            </li>
                            <li class="menu-item">
                                <a href="settings.html" class="menu-link">Restaurant Settings</a>
                            </li>
                        </ul>
                    </li>

                    <li class="menu-item">
                        <a href="my-profile.html" class="menu-link">
                            <span class="material-symbols-outlined menu-icon">account_circle</span>
                            <span class="title">My Profile</span>
                        </a>
                    </li>

                    <li class="menu-item">
                        <a href="#" class="menu-link" onclick="if(window.authService) { window.authService.logout(); } return false;">
                            <span class="material-symbols-outlined menu-icon">logout</span>
                            <span class="title">Logout</span>
                        </a>
                    </li>
                </ul>
            </aside>
        </div>
        <!-- End Sidebar Area -->

        <!-- Start Main Content Area -->
        <div class="container-fluid">
            <div class="main-content d-flex flex-column">
                <!-- Start Header Area -->
                <header class="header-area bg-white mb-4 rounded-10 border border-white" id="header-area">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <div class="left-header-content">
                                <ul class="d-flex align-items-center ps-0 mb-0 list-unstyled justify-content-center justify-content-md-start">
                                    <li class="d-xl-none">
                                        <button class="header-burger-menu bg-transparent p-0 border-0 position-relative top-3" id="header-burger-menu">
                                            <span class="border-1 d-block for-dark-burger" style="border-bottom: 1px solid #475569; height: 1px; width: 25px;"></span>
                                            <span class="border-1 d-block for-dark-burger" style="border-bottom: 1px solid #475569; height: 1px; width: 25px; margin: 6px 0;"></span>
                                            <span class="border-1 d-block for-dark-burger" style="border-bottom: 1px solid #475569; height: 1px; width: 25px;"></span>
                                        </button>
                                    </li>
                                    <li>
                                        <form class="src-form position-relative">
                                            <input type="text" class="form-control" placeholder="Search here...">
                                            <div class="src-btn position-absolute top-50 start-0 translate-middle-y bg-transparent p-0 border-0">
                                                <span class="material-symbols-outlined">search</span>
                                            </div>
                                        </form>
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="right-header-content mt-3 mt-md-0">
                                <ul class="d-flex align-items-center justify-content-center justify-content-md-end ps-0 mb-0 list-unstyled">
                                    <li class="header-right-item language-item">
                                        <div class="dropdown notifications language">
                                            <button class="btn btn-secondary dropdown-toggle border-0 p-0 position-relative" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                <span class="material-symbols-outlined" style="font-size: 19px;">translate</span>
                                            </button>
                                            <div class="dropdown-menu dropdown-lg p-0 border-0 dropdown-menu-end">
                                                <span class="fw-medium fs-16 text-secondary d-block title" style="padding-top: 20px; padding-bottom: 20px;">Choose Language</span>
                                                <div class="max-h-275" data-simplebar>
                                                    <div class="notification-menu">
                                                        <a href="javascript:void(0);" class="dropdown-item language-option" data-lang="en" data-lang-code="en">
                                                            <div class="d-flex align-items-center">
                                                                <div class="flex-shrink-0">
                                                                    <img src="../assets/images/usa.png" class="wh-30 rounded-circle" alt="usa">
                                                                </div>
                                                                <div class="flex-grow-1 ms-10">
                                                                    <span class="text-secondary fw-medium fs-15">English</span>
                                                                </div>
                                                            </div>
                                                        </a>
                                                    </div>
                                                    <div class="notification-menu">
                                                        <a href="javascript:void(0);" class="dropdown-item language-option" data-lang="en-AU" data-lang-code="en">
                                                            <div class="d-flex align-items-center">
                                                                <div class="flex-shrink-0">
                                                                    <img src="../assets/images/australia.png" class="wh-30 rounded-circle" alt="australia">
                                                                </div>
                                                                <div class="flex-grow-1 ms-10">
                                                                    <span class="text-secondary fw-medium fs-15">Australia</span>
                                                                </div>
                                                            </div>
                                                        </a>
                                                    </div>
                                                    <div class="notification-menu">
                                                        <a href="javascript:void(0);" class="dropdown-item language-option" data-lang="es" data-lang-code="es">
                                                            <div class="d-flex align-items-center">
                                                                <div class="flex-shrink-0">
                                                                    <img src="../assets/images/spain.png" class="wh-30 rounded-circle" alt="spain">
                                                                </div>
                                                                <div class="flex-grow-1 ms-10">
                                                                    <span class="text-secondary fw-medium fs-15">Spanish</span>
                                                                </div>
                                                            </div>
                                                        </a>
                                                    </div>
                                                    <div class="notification-menu">
                                                        <a href="javascript:void(0);" class="dropdown-item language-option" data-lang="fr" data-lang-code="fr">
                                                            <div class="d-flex align-items-center">
                                                                <div class="flex-shrink-0">
                                                                    <img src="../assets/images/france.png" class="wh-30 rounded-circle" alt="portugal">
                                                                </div>
                                                                <div class="flex-grow-1 ms-10">
                                                                    <span class="text-secondary fw-medium fs-15">France</span>
                                                                </div>
                                                            </div>
                                                        </a>
                                                    </div>
                                                    <div class="notification-menu mb-0">
                                                        <a href="javascript:void(0);" class="dropdown-item language-option" data-lang="de" data-lang-code="de">
                                                            <div class="d-flex align-items-center">
                                                                <div class="flex-shrink-0">
                                                                    <img src="../assets/images/germany.png" class="wh-30 rounded-circle" alt="Germany">
                                                                </div>
                                                                <div class="flex-grow-1 ms-10">
                                                                    <span class="text-secondary fw-medium fs-15">German</span>
                                                                </div>
                                                            </div>
                                                        </a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                    <li class="header-right-item light-dark-item">
                                        <div class="light-dark">
                                            <button class="switch-toggle dark-btn p-0 bg-transparent lh-0 border-0" id="switch-toggle">
                                                <span class="dark"><i class="material-symbols-outlined">dark_mode</i></span> 
                                                <span class="light"><i class="material-symbols-outlined">light_mode</i></span>
                                            </button>
                                        </div>
                                    </li>
                                    <li class="header-right-item calendar-item">
                                        <div class="dropdown notifications">
                                            <a href="blank-page.html" class="btn btn-secondary border-0 p-0 position-relative">
                                                <span class="material-symbols-outlined" style="font-size: 19px;">calendar_today</span>
                                            </a>
                                        </div>
                                    </li>
                                    <li class="header-right-item messages-item">
                                        <div class="dropdown notifications noti messages">
                                            <button class="btn btn-secondary border-0 p-0 position-relative" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                <span class="material-symbols-outlined">mail</span>
                                                <span class="count bg-primary">5</span>
                                            </button>
                                            <div class="dropdown-menu dropdown-lg p-0 border-0 p-0 dropdown-menu-end">
                                                <div class="d-flex justify-content-between align-items-center title">
                                                    <span class="fw-medium fs-16 text-secondary">Messages <span class="fw-normal text-body fs-16">(03)</span></span>
                                                    <button class="p-0 m-0 bg-transparent border-0 fs-15 text-primary fw-medium">Mark all as read</button>
                                                </div> 

                                                <div style="max-height: 300px;" data-simplebar>
                                                    <div class="notification-menu unseen">
                                                        <a href="blank-page.html" class="dropdown-item">
                                                            <div class="d-flex align-items-center">
                                                                <div class="flex-shrink-0">
                                                                    <img src="../assets/images/user1.jpg" class="rounded-circle" style="width: 44px; height: 44px;" alt="images">
                                                                </div>
                                                                <div class="flex-grow-1 ms-10">
                                                                    <p class="fs-16 fw-medium text-secondary mb-2">Jacob Liwiski <span class="fs-14 fw-normal text-body ms-2">35 min ago</span></p>
                                                                    <span class="fs-14-5 fw-medium d-inline-block" style="line-height: 1.4;">Hey Victor! Could you please...</span>
                                                                </div>
                                                            </div>
                                                        </a>
                                                    </div>
                                                    <div class="notification-menu unseen">
                                                        <a href="blank-page.html" class="dropdown-item">
                                                            <div class="d-flex align-items-center">
                                                                <div class="flex-shrink-0">
                                                                    <img src="../assets/images/user2.jpg" class="rounded-circle" style="width: 44px; height: 44px;" alt="images">
                                                                </div>
                                                                <div class="flex-grow-1 ms-10">
                                                                    <p class="fs-16 fw-medium text-secondary mb-2">Angela Carter <span class="fs-14 fw-normal text-body ms-2">1 day ago</span></p>
                                                                    <span class="fs-14-5 fw-medium d-inline-block" style="line-height: 1.4;">How are you Angela? Would you please...</span>
                                                                </div>
                                                            </div>
                                                        </a>
                                                    </div>
                                                    <div class="notification-menu">
                                                        <a href="blank-page.html" class="dropdown-item">
                                                            <div class="d-flex align-items-center">
                                                                <div class="flex-shrink-0">
                                                                    <img src="../assets/images/user3.jpg" class="rounded-circle" style="width: 44px; height: 44px;" alt="images">
                                                                </div>
                                                                <div class="flex-grow-1 ms-10">
                                                                    <p class="fs-16 fw-medium text-secondary mb-2">Brad Traversy <span class="fs-14 fw-normal text-body ms-2">2 days ago</span></p>
                                                                    <span class="fs-14-5 fw-medium d-inline-block" style="line-height: 1.4;">Hey Brad Traversy! Could you please...</span>
                                                                </div>
                                                            </div>
                                                        </a>
                                                    </div>
                                                </div>

                                                <a href="blank-page.html" class="dropdown-item text-center text-primary d-block view-all fw-medium rounded-bottom-3">
                                                    <span>See All Messages</span>
                                                </a>
                                            </div>
                                        </div>
                                    </li>
                                    <li class="header-right-item">
                                        <div class="dropdown notifications noti">
                                            <button class="btn btn-secondary border-0 p-0 position-relative" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                <span class="material-symbols-outlined">notifications</span>
                                                <span class="count">3</span>
                                            </button>
                                            <div class="dropdown-menu dropdown-lg p-0 border-0 p-0 dropdown-menu-end">
                                                <div class="d-flex justify-content-between align-items-center title">
                                                    <span class="fw-medium fs-16 text-secondary">Notifications <span class="fw-normal text-body fs-16">(03)</span></span>
                                                    <button class="p-0 m-0 bg-transparent border-0 fs-15 text-primary fw-medium">Clear All</button>
                                                </div> 

                                                <div style="max-height: 300px;" data-simplebar>
                                                    <div class="notification-menu unseen">
                                                        <a href="notifications.html" class="dropdown-item">
                                                            <div class="d-flex align-items-center">
                                                                <div class="flex-shrink-0">
                                                                    <i class="material-symbols-outlined text-primary">sms</i>
                                                                </div>
                                                                <div class="flex-grow-1 ms-3">
                                                                    <p class="fs-16 fw-medium text-secondary">You have requested to withdrawal</p>
                                                                    <span class="fs-14 fw-medium">2 hrs ago</span>
                                                                </div>
                                                            </div>
                                                        </a>
                                                    </div>
                                                    <div class="notification-menu unseen">
                                                        <a href="notifications.html" class="dropdown-item">
                                                            <div class="d-flex align-items-center">
                                                                <div class="flex-shrink-0">
                                                                    <i class="material-symbols-outlined text-info">person</i>
                                                                </div>
                                                                <div class="flex-grow-1 ms-3">
                                                                    <p class="fs-16 fw-medium text-secondary">A new user added in Cloudignite</p>
                                                                    <span class="fs-14 fw-medium">3 hrs ago</span>
                                                                </div>
                                                            </div>
                                                        </a>
                                                    </div>
                                                    <div class="notification-menu">
                                                        <a href="notifications.html" class="dropdown-item">
                                                            <div class="d-flex align-items-center">
                                                                <div class="flex-shrink-0">
                                                                    <i class="material-symbols-outlined text-success">mark_email_unread</i>
                                                                </div>
                                                                <div class="flex-grow-1 ms-3">
                                                                    <p class="fs-16 fw-medium text-secondary">You have requested to withdrawal</p>
                                                                    <span class="fs-14 fw-medium">1 day ago</span>
                                                                </div>
                                                            </div>
                                                        </a>
                                                    </div>
                                                </div>

                                                <a href="notifications.html" class="dropdown-item text-center text-primary d-block view-all fw-medium rounded-bottom-3">
                                                    <span>See All Notifications </span>
                                                </a>
                                            </div>
                                        </div>
                                    </li>
                                    <li class="header-right-item">
                                        <div class="dropdown admin-profile">
                                            <div class="d-xxl-flex align-items-center bg-transparent border-0 text-start p-0 cursor dropdown-toggle" data-bs-toggle="dropdown">
                                                <div class="flex-shrink-0 position-relative">
                                                    <img class="rounded-circle admin-img-width-for-mobile" style="width: 40px; height: 40px;" src="../assets/images/admin.png" alt="admin">
                                                    <span class="d-block bg-success-60 border border-2 border-white rounded-circle position-absolute end-0 bottom-0" style="width: 11px; height: 11px;"></span>
                                                </div>
                                            </div>
    
                                            <div class="dropdown-menu border-0 bg-white dropdown-menu-end">
                                                <div class="d-flex align-items-center info">
                                                    <div class="flex-shrink-0">
                                                        <img class="rounded-circle admin-img-width-for-mobile" style="width: 40px; height: 40px;" src="../assets/images/admin.png" alt="admin">
                                                    </div>
                                                    <div class="flex-grow-1 ms-10">
                                                        <h3 class="fw-medium fs-17 mb-0 user-name">Loading...</h3>
                                                        <span class="fs-15 fw-medium user-role">Loading...</span>
                                                    </div>
                                                </div>
                                                <ul class="admin-link mb-0 list-unstyled">
                                                    <li>
                                                        <a class="dropdown-item admin-item-link d-flex align-items-center text-body" href="my-profile.html">
                                                            <i class="material-symbols-outlined">person</i>
                                                            <span class="ms-2">My Profile</span>
                                                        </a>
                                                    </li>
                                                    <li>
                                                        <a class="dropdown-item admin-item-link d-flex align-items-center text-body" href="settings.html">
                                                            <i class="material-symbols-outlined">settings</i>
                                                            <span class="ms-2">Settings</span>
                                                        </a>
                                                    </li>
                                                    <li>
                                                        <a class="dropdown-item admin-item-link d-flex align-items-center text-body" href="alerts.html">
                                                            <i class="material-symbols-outlined">info</i>
                                                            <span class="ms-2">Support</span>
                                                        </a>
                                                    </li>
                                                    <li>
                                                        <a class="dropdown-item admin-item-link d-flex align-items-center text-body" href="#" onclick="if(window.authService) { window.authService.logout(); } return false;">
                                                            <i class="material-symbols-outlined">logout</i>
                                                            <span class="ms-2">Logout</span>
                                                        </a>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </header>
                <!-- End Header Area -->

                <div class="main-content-container overflow-hidden">
                    <div id="owner-view-disabled-banner" class="alert alert-secondary border-secondary mb-4 d-none" role="alert">
                        <span class="material-symbols-outlined align-middle me-2">visibility_off</span>
                        Owner View is currently disabled. You can use the full dashboard below.
                        <button type="button" class="btn-close float-end" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                    <div id="purchase-data-missing-banner" class="alert alert-warning border-warning mb-4 d-none" role="alert">
                        <div class="d-flex align-items-center flex-wrap gap-3">
                            <span class="material-symbols-outlined fs-32 text-warning">warning</span>
                            <div class="flex-grow-1">
                                <strong>Critical: Purchase data missing.</strong> Without purchase data, food cost %, waste %, and loss sources cannot be calculated. 
                                <a href="manual-data-entry.html" class="alert-link fw-medium">Manual Data Entry → Invoice upload</a> to unlock full cost control.
                            </div>
                            <a href="manual-data-entry.html" class="btn btn-warning btn-sm">Add purchases</a>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="card bg-white p-20 rounded-10 border border-white mb-4">
                                <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                                    <div>
                                        <h3 id="loss-summary-section-title" class="mb-0">Weekly P&L</h3>
                                        <p id="loss-summary-section-subtitle" class="mb-0 mt-1 fs-14 text-danger d-none"></p>
                                    </div>
                                    <div class="dropdown select-dropdown without-border">
                                        <button id="loss-summary-period-btn" class="dropdown-toggle bg-transparent text-secondary fs-15" data-bs-toggle="dropdown" aria-expanded="false">
                                            This Week
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end bg-white border-0 box-shadow rounded-10" data-simplebar>
                                            <li><button type="button" class="dropdown-item text-secondary" data-period="weekly">○ Weekly</button></li>
                                            <li><button type="button" class="dropdown-item text-secondary" data-period="monthly">○ Monthly</button></li>
                                            <li><button type="button" class="dropdown-item text-secondary" data-period="quarterly">○ Quarterly</button></li>
                                        </ul>
                                    </div>
                                </div>
                                <div id="priority-alert-box" class="mb-3 d-none">
                                    <div class="alert alert-warning border-warning mb-0 shadow-sm">
                                        <h5 class="alert-heading mb-2"><span class="badge bg-danger me-2">PRIORITY 1</span> Fix this first</h5>
                                        <p id="priority-alert-message" class="mb-2 fs-14">—</p>
                                        <ul id="priority-alert-steps" class="mb-2 ps-3 fs-14"> </ul>
                                        <a href="analytics.html" class="btn btn-sm btn-warning">View action plan</a>
                                    </div>
                                </div>
                                <div id="total_sales_chart" style="margin-bottom: -16px; margin-top: -1.5px;"></div>
                            </div>
                        </div>

                        <div class="col-lg-6 col-xxl-3 col-xxxl-6">
                            <div class="row">
                                <div class="col-md-6 col-lg-12">
                                    <div class="card bg-white p-20 rounded-10 border border-white mb-4">
                                        <div class="d-flex">
                                            <div class="flex-grow-1">
                                                <h3 id="weekly-loss-card-label" class="mb-10">Gross P&L</h3>
                                                <h2 id="weekly-loss-value" class="fs-26 fw-medium mb-0 lh-1" title="">—</h2>
                                            </div>
                                            <div class="flex-shrink-0 ms-3">
                                                <div id="weekly-loss-icon-wrap" class="bg-danger text-white text-center rounded-circle d-block" style="width: 75px; height: 75px; line-height: 105px;">
                                                    <i class="material-symbols-outlined fs-40">trending_down</i>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center" style="margin-top: 21px;">
                                            <p id="weekly-loss-subtitle" class="mb-0 fs-14">Sales − (Food + Labor + Waste)</p>
                                            <span class="d-flex align-content-center gap-1 bg-success bg-opacity-10 border border-success" style="padding: 3px 5px;">
                                                <i class="material-symbols-outlined fs-14 text-success">trending_down</i>
                                                <span class="lh-1 fs-14 text-success">13%</span>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-12">
                                    <div class="card bg-white p-20 rounded-10 border border-white mb-4">
                                        <div class="d-flex">
                                            <div class="flex-grow-1">
                                                <h3 class="mb-10">Food Cost %</h3>
                                                <h2 class="fs-26 fw-medium mb-0 lh-1">34.2%</h2>
                                            </div>
                                            <div class="flex-shrink-0 ms-3">
                                                <div class="bg-warning text-white text-center rounded-circle d-block" style="width: 75px; height: 75px; line-height: 105px;">
                                                    <i class="material-symbols-outlined fs-40">percent</i>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center" style="margin-top: 21px;">
                                            <p id="food-cost-subtitle" class="mb-0 fs-14">Target: 28%</p>
                                            <span class="d-flex align-content-center gap-1 bg-danger bg-opacity-10 border border-danger" style="padding: 3px 5px;">
                                                <i class="material-symbols-outlined fs-14 text-danger">warning</i>
                                                <span class="lh-1 fs-14 text-danger">High</span>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-xl-12 col-xxl-3 col-xxxl-12">
                            <div class="row">
                                <div class="col-md-6 col-xxxl-6 col-xxl-12">
                                    <div class="card bg-white p-20 rounded-10 border border-white mb-4">
                                        <div class="d-flex">
                                            <div class="flex-grow-1">
                                                <h3 id="savings-card-label" class="mb-10">Gross Loss This Period</h3>
                                                <h2 id="monthly-savings-amount" class="fs-26 fw-medium mb-0 lh-1" title="">—</h2>
                                            </div>
                                            <div class="flex-shrink-0 ms-3">
                                                <div class="bg-success text-white text-center rounded-circle d-block" style="width: 75px; height: 75px; line-height: 116px;">
                                                    <i class="material-symbols-outlined fs-50">savings</i>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center" style="margin-top: 23px;">
                                            <p id="savings-card-tooltip" class="mb-0 fs-14">Sales − (Food + Labor + Waste). Same number as Gross P&L.</p>
                                            <button id="view-breakdown-btn" class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#savingsBreakdownModal" style="padding: 3px 8px; font-size: 12px; white-space: nowrap;">
                                                <i class="material-symbols-outlined fs-14">info</i> View Breakdown
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 col-xxxl-6 col-xxl-12">
                                    <div class="bg-primary-50 p-20 border rounded-10 border-primary-50 mb-4">
                                        <h3 class="text-white mb-12">Loss Overview</h3>
                                        <div class="d-flex flex-wrap gap-2 justify-content-between mb-14">
                                            <div>
                                                <span id="loss-overview-weekly-label" class="fs-14 text-white mb-1 d-block">Loss (Period)</span>
                                                <h2 class="fs-20 fw-medium lh-1 text-white mb-0" id="loss-overview-weekly">—</h2>
                                            </div>
                                            <div>
                                                <span id="loss-overview-monthly-label" class="fs-14 text-white mb-1 d-block">Period Loss</span>
                                                <h2 class="fs-20 fw-medium lh-1 text-white mb-0" id="loss-overview-monthly">—</h2>
                                            </div>
                                            <div>
                                                <span class="fs-14 text-white mb-1 d-block">Waste %</span>
                                                <h2 class="fs-20 fw-medium lh-1 text-white mb-0" id="loss-overview-waste">8.5%</h2>
                                            </div>
                                        </div>
                                        <div class="progress rounded-0 mb-6" role="progressbar" aria-label="Waste progress" style="height: 3px; background-color: #6258cc;">
                                            <div class="progress-bar rounded-0 bg-white" id="loss-overview-waste-bar" style="width: 8.5%; height: 3px;"></div>
                                        </div>
                                        <span class="fs-14 text-white d-block" id="loss-overview-waste-target" style="margin-bottom: -6px;">Target waste: 5% (currently 8.5%)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Prime Cost: Food % + Labor % – target 55–65%. The #1 restaurant KPI. -->
                        <div class="col-12 mt-2">
                            <div class="card border-0 mb-4 overflow-hidden" id="prime-cost-card">
                                <div class="row g-0 align-items-center">
                                    <div class="col-md-8 p-20">
                                        <div class="d-flex align-items-center gap-3 flex-wrap">
                                            <div class="rounded-circle d-flex align-items-center justify-content-center" style="width: 56px; height: 56px; background: linear-gradient(135deg, #0d6efd 0%, #6610f2 100%);">
                                                <i class="material-symbols-outlined text-white fs-28">analytics</i>
                                            </div>
                                            <div>
                                                <h3 class="mb-1 fw-semibold">Prime Cost</h3>
                                                <p class="fs-14 text-body mb-0">Food Cost % + Labor Cost %. Target: 55–65% of sales.</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4 p-20 bg-light text-md-end">
                                        <h2 class="fs-28 fw-bold mb-1 lh-1" id="prime-cost-value">67.0%</h2>
                                        <span class="badge" id="prime-cost-badge">Food 34.2% + Labor 32.8%</span>
                                        <p class="fs-13 text-muted mt-2 mb-0" id="prime-cost-status">Above target. Reduce food or labor cost.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xxl-6 col-xxxl-12">
                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="card bg-white p-20 rounded-10 border border-white mb-4">
                                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mb-20">
                                            <h3>Loss by Category <span id="loss-by-category-period" class="fs-14 fw-normal text-muted"></span></h3>
        
                                            <div class="dropdown select-dropdown without-border">
                                                <button id="loss-by-category-period-btn" class="dropdown-toggle bg-transparent text-secondary fs-15" data-bs-toggle="dropdown" aria-expanded="false">
                                                    —
                                                </button>
                                            
                                                <ul class="dropdown-menu dropdown-menu-end bg-white border-0 box-shadow rounded-10" data-simplebar>
                                                    <li>
                                                        <button class="dropdown-item text-secondary">Last Week</button>
                                                    </li>
                                                    <li>
                                                        <button class="dropdown-item text-secondary">Last Month</button>
                                                    </li>
                                                    <li>
                                                        <button class="dropdown-item text-secondary">Last Quarter</button>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                        
                                        <h2 id="loss-by-category-total" class="lh-1 fs-26 fw-medium" style="margin-bottom: -10px;">—</h2>

                                        <div id="profit_chart" style="margin-bottom: -17px;"></div>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="card bg-white p-20 rounded-10 border border-white mb-4">
                                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mb-20">
                                            <h3>Labor Cost %</h3>
                                            <span class="d-flex align-content-center gap-1 bg-warning bg-opacity-10 border border-warning" style="padding: 3px 5px;">
                                                <i class="material-symbols-outlined fs-14 text-warning">warning</i>
                                                <span class="lh-1 fs-14 text-warning" id="labor-cost-badge">High</span>
                                            </span>
                                        </div>
                                        <h2 class="lh-1 fs-26 fw-medium mb-0" id="labor-cost-value">32.8%</h2>
                                        <div id="average_daily_sales_chart" style="margin-bottom: -17px;"></div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card p-20 bg-light-40 rounded-10 border-light-40 mb-4 position-relative z-1">
                                        <h3 class="mb-20">Biggest Loss Source</h3>
                                        <h3 id="biggest-loss-category" class="mb-12 text-danger">—</h3>
                                        <h2 id="biggest-loss-amount" class="lh-1 fs-26 fw-medium">—<span class="fs-16 text-body" id="biggest-loss-period">(This Month)</span></h2>
                                        <a id="biggest-loss-link" href="analytics.html" class="fw-medium fs-16 text-secondary hover-text d-inline-block" style="margin-top: 84px;">View Details</a>
                                        <span class="material-symbols-outlined position-absolute bottom-0 end-0 pe-3" style="font-size: 80px; opacity: 0.3; color: #dc3545;">delete</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card p-20 bg-white rounded-10 border border-white mb-4 position-relative z-1">
                                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mb-20">
                                            <h3>Action Items</h3>
                                            <span id="action-items-badge" class="d-flex align-content-center gap-1 bg-secondary bg-opacity-10 border border-secondary" style="padding: 3px 5px;">
                                                <i class="material-symbols-outlined fs-14 text-secondary">info</i>
                                                <span id="action-items-badge-num" class="lh-1 fs-14 text-secondary">—</span>
                                            </span>
                                        </div>
                                        <h2 id="action-items-count" class="lh-1 fs-26 fw-medium">—</h2>
                                        <div style="margin-top: 55px;">
                                            <span id="action-items-subtitle" class="fs-16 text-body d-block mb-10">Loading…</span>
                                            <ul class="p-0 mb-0 list-unstyled" id="action-items-list">
                                                <li class="text-center text-muted py-3">
                                                    <div class="spinner-border spinner-border-sm me-2"></div>Loading action items...
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xxl-6 col-xxxl-12">
                            <div class="card bg-white p-20 rounded-10 border border-white mb-4">
                                <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mb-20">
                                    <h3>Top 5 Loss Sources</h3>

                                    <div class="dropdown select-dropdown without-border">
                                        <button id="top-loss-sources-period-btn" class="dropdown-toggle bg-transparent text-secondary fs-15" data-bs-toggle="dropdown" aria-expanded="false">
                                            —
                                        </button>
                                    
                                        <ul class="dropdown-menu dropdown-menu-end bg-white border-0 box-shadow rounded-10" data-simplebar>
                                            <li>
                                                <button class="dropdown-item text-secondary">This Week</button>
                                            </li>
                                            <li>
                                                <button class="dropdown-item text-secondary">This Month</button>
                                            </li>
                                            <li>
                                                <button class="dropdown-item text-secondary">Last Quarter</button>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                
                                <div class="default-table-area without-header table-top-selling-products">
                                    <div class="table-responsive">
                                        <table class="table align-middle" id="top-loss-sources-table">
                                            <thead class="visually-hidden"><tr><th></th><th></th><th></th><th></th><th class="text-end">Action</th></tr></thead>
                                            <tbody id="top-loss-sources-tbody">
                                                <tr>
                                                    <td colspan="5" class="text-center text-muted py-4">
                                                        <div class="spinner-border spinner-border-sm me-2"></div>Loading loss sources...
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
        
                                    <div class="d-flex justify-content-center justify-content-sm-between align-items-center text-center flex-wrap gap-2 showing-wrap pt-15">
                                        <span id="top-loss-sources-period-note" class="fs-15">Showing top 5 loss sources</span>
        
                                        <a href="analytics.html" class="btn btn-primary btn-sm">View All Loss Sources</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-6 col-xxl-4 col-xxxl-6 mb-4">
                            <div class="card bg-white p-20 rounded-10 border border-white">
                                <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mb-20">
                                    <h3>Cost Breakdown by Category</h3>

                                    <div class="dropdown select-dropdown without-border">
                                        <button id="cost-breakdown-period-btn" class="dropdown-toggle bg-transparent text-secondary fs-15" data-bs-toggle="dropdown" aria-expanded="false">
                                            —
                                        </button>
                                    
                                        <ul class="dropdown-menu dropdown-menu-end bg-white border-0 box-shadow rounded-10" data-simplebar>
                                            <li>
                                                <button class="dropdown-item text-secondary">This Week</button>
                                            </li>
                                            <li>
                                                <button class="dropdown-item text-secondary">This Month</button>
                                            </li>
                                            <li>
                                                <button class="dropdown-item text-secondary">Last Quarter</button>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                
                                <div class="d-flex justify-content-between align-items-center mb-20" id="cost-breakdown-labels">
                                    <span id="cost-breakdown-waste" class="fs-15 text-secondary">—</span>
                                    <span id="cost-breakdown-labor" class="fs-15 text-secondary">—</span>
                                    <span id="cost-breakdown-inv" class="fs-15 text-secondary">—</span>
                                </div>
                                <div id="order_summary_chart"></div>
                                <p id="cost-breakdown-empty" class="small text-muted mb-0 mt-2" style="display: none;">Add purchase and waste data to see cost breakdown.</p>
                            </div>
                        </div>
                        <div class="col-lg-6 col-xxl-4 col-xxxl-6">
                            <div class="card bg-white p-20 rounded-10 border border-white mb-4">
                                <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mb-20">
                                    <h3>Highest Cost Inventory Items</h3>

                                    <div class="dropdown select-dropdown without-border">
                                        <button id="highest-cost-inventory-period-btn" class="dropdown-toggle bg-transparent text-secondary fs-15" data-bs-toggle="dropdown" aria-expanded="false">
                                            —
                                        </button>
                                    
                                        <ul class="dropdown-menu dropdown-menu-end bg-white border-0 box-shadow rounded-10" data-simplebar>
                                            <li>
                                                <button class="dropdown-item text-secondary">This Day</button>
                                            </li>
                                            <li>
                                                <button class="dropdown-item text-secondary">This Week</button>
                                            </li>
                                            <li>
                                                <button class="dropdown-item text-secondary">This Month</button>
                                            </li>
                                            <li>
                                                <button class="dropdown-item text-secondary">This Year</button>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                
                                <div class="default-table-area without-header table-top-sellers">
                                    <div class="table-responsive">
                                        <table class="table align-middle">
                                            <tbody id="inventory-items-table-body">
                                                <tr>
                                                    <td colspan="3" class="text-center text-muted py-4">
                                                        <i class="ri-loader-4-line me-2"></i>Loading inventory items...
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-12 col-xxl-4 col-xxxl-12">
                            <div class="row">
                                <div class="col-xxl-12 col-lg-6 col-xxxl-6">
                                    <div class="card bg-white p-20 rounded-10 border border-white mb-4">
                                        <h3 class="mb-20">Top Suppliers</h3>
                                        <div class="row align-items-center">
                                            <div class="col-lg-12">
                                                <ul class="p-0 mb-0 list-unstyled last-child-none mt-4 mt-sm-0" id="top-suppliers-list">
                                                    <li class="text-center text-muted py-4">
                                                        <i class="ri-loader-4-line me-2"></i>Loading suppliers...
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-xxl-12 col-lg-6 col-xxxl-6">
                                    <div class="card bg-white p-20 rounded-10 border border border-white mb-4">
                                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mb-0">
                                            <div>
                                                <h3>Revenue</h3>
                                                <p id="revenue-this-week-label" class="fs-14 text-body mb-0">This Week: —</p>
                                            </div>
                                            <div class="dropdown select-dropdown without-border">
                                                <button id="revenue-period-btn" class="dropdown-toggle bg-transparent text-secondary fs-15" data-bs-toggle="dropdown" aria-expanded="false">
                                                    —
                                                </button>
                                            
                                                <ul class="dropdown-menu dropdown-menu-end bg-white border-0 box-shadow rounded-10" data-simplebar>
                                                    <li><button class="dropdown-item text-secondary">This Day</button></li>
                                                    <li><button class="dropdown-item text-secondary">This Week</button></li>
                                                    <li><button class="dropdown-item text-secondary">This Month</button></li>
                                                    <li><button class="dropdown-item text-secondary">This Year</button></li>
                                                </ul>
                                            </div>
                                        </div>
        
                                        <div id="revenue_chart" style="margin-bottom: -17px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xxl-8 col-xxxxl-12">
                            <div class="card bg-white rounded-10 border border-white mb-4">
                                <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 p-20">
                                    <h3>Recent Cost Issues</h3>

                                    <div class="d-flex align-items-center">
                                        <div class="dropdown select-dropdown without-border">
                                            <button class="dropdown-toggle bg-transparent text-secondary fs-15" data-bs-toggle="dropdown" aria-expanded="false">
                                                Show All
                                            </button>
                                        
                                            <ul class="dropdown-menu dropdown-menu-end bg-white border-0 box-shadow rounded-10" data-simplebar>
                                                <li>
                                                    <button class="dropdown-item text-secondary">High Priority</button>
                                                </li>
                                                <li>
                                                    <button class="dropdown-item text-secondary">Resolved</button>
                                                </li>
                                                <li>
                                                    <button class="dropdown-item text-secondary">Pending</button>
                                                </li>
                                                <li>
                                                    <button class="dropdown-item text-secondary">All Issues</button>
                                                </li>
                                            </ul>
                                        </div>

                                        <form class="table-src-form position-relative">
                                            <input type="text" class="form-control" placeholder="Search here...">
                                            <div class="src-btn position-absolute top-50 start-0 translate-middle-y bg-transparent p-0 border-0">
                                                <span class="material-symbols-outlined">search</span>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                                
                                <div class="default-table-area mx-minus-1 table-recent-orders">
                                    <div class="table-responsive">
                                        <table class="table align-middle">
                                            <thead>
                                                <tr>
                                                    <th scope="col" class="fw-medium">Issue ID</th>
                                                    <th scope="col" class="fw-medium">Category</th>
                                                    <th scope="col" class="fw-medium">Date</th>
                                                    <th scope="col" class="fw-medium">Loss Amount</th>
                                                    <th scope="col" class="fw-medium">Impact</th>
                                                    <th scope="col" class="fw-medium">Status</th>
                                                    <th scope="col" class="fw-medium">Action</th>
                                                </tr>
                                            </thead>
                                            <tbody id="cost-issues-table-body">
                                                <tr>
                                                    <td colspan="7" class="text-center text-muted py-4">
                                                        <i class="ri-loader-4-line me-2"></i>Loading cost issues...
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
        
                                    <div class="d-flex justify-content-center justify-content-sm-between align-items-center text-center flex-wrap gap-2 showing-wrap pt-15 p-20">
                                        <span class="fs-15">Showing 1 to 5 of 50 entries</span>
        
                                        <nav class="custom-pagination" aria-label="Page navigation example">
                                            <ul class="pagination mb-0 justify-content-center">
                                                <li class="page-item">
                                                    <button class="page-link icon" aria-label="Previous">
                                                        <i class="material-symbols-outlined">west</i>
                                                    </button>
                                                </li>
                                                <li class="page-item">
                                                    <button class="page-link active">1</button>
                                                </li>
                                                <li class="page-item">
                                                    <button class="page-link">2</button>
                                                </li>
                                                <li class="page-item">
                                                    <button class="page-link">3</button>
                                                </li>
                                                <li class="page-item">
                                                    <button class="page-link icon" aria-label="Next">
                                                        <i class="material-symbols-outlined">east</i>
                                                    </button>
                                                </li>
                                            </ul>
                                        </nav>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xxl-4 col-xxxxl-12">
                            <div class="card bg-white p-20 rounded-10 border border-white mb-4">
                                <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mb-0" role="button" data-bs-toggle="collapse" data-bs-target="#recently-captured-data-collapse" aria-expanded="true" aria-controls="recently-captured-data-collapse" id="recently-captured-data-toggle">
                                    <h3 class="mb-0 d-flex align-items-center gap-2">
                                        <span>Recently Captured Data</span>
                                        <i class="ri-arrow-down-s-line fs-24 transition-transform" id="recently-captured-data-chevron" style="transform: rotate(0deg);"></i>
                                    </h3>
                                    <a href="manual-data-entry.html" class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation();">View All</a>
                                </div>
                                
                                <div class="collapse show default-table-area table-recent-orders mt-20" id="recently-captured-data-collapse">
                                    <div class="table-responsive">
                                        <table class="table align-middle table-hover">
                                            <thead>
                                                <tr>
                                                    <th class="fw-medium">Type</th>
                                                    <th class="fw-medium">Date</th>
                                                    <th class="fw-medium">Description</th>
                                                    <th class="fw-medium">Amount</th>
                                                    <th class="fw-medium">Status</th>
                                                    <th class="fw-medium">Action</th>
                                                </tr>
                                            </thead>
                                            <tbody id="cost-transactions-table-body">
                                                <tr>
                                                    <td colspan="6" class="text-center text-muted py-4">
                                                        <i class="ri-loader-4-line me-2"></i>Loading recent captures...
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="d-flex justify-content-center justify-content-sm-between align-items-center text-center flex-wrap gap-2 showing-wrap pt-15">
                                        <span class="fs-15 showing-entries" id="recent-captures-showing">Showing 0 entries</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex-grow-1"></div>

                <!-- Start Footer Area -->
                <footer class="footer-area bg-white text-center rounded-10 rounded-bottom-0">
                    <p class="fs-16 text-body">© Cloudignite</p>
                </footer>
                <!-- End Footer Area -->
            </div>
        </div>
        <!-- Start Main Content Area -->

        <!-- Start Theme Setting Area -->
        <button class="btn btn-primary theme-settings-btn p-0 position-fixed z-2 text-center rounded-circle" style="bottom: 24px; right: 24px; width: 56px; height: 56px; line-height: 54px;" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasScrolling" aria-controls="offcanvasScrolling">
            <i class="text-white ri-settings-3-fill fs-28" data-bs-toggle="tooltip" data-bs-placement="left" data-bs-title="Click On Theme Settings"></i>
        </button>

        <!-- Start Theme Setting Area -->
        <div class="offcanvas offcanvas-end bg-white border-0" data-bs-scroll="true" data-bs-backdrop="true" tabindex="-1" id="offcanvasScrolling" aria-labelledby="offcanvasScrollingLabel" style="box-shadow: 0 4px 20px #2f8fe812 !important; max-width: 300px;">
            <div class="offcanvas-header bg-light p-20">
                <h5 class="offcanvas-title fs-18 fw-medium" id="offcanvasScrollingLabel">Configuration Panel</h5>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body p-0 overflow-hidden">
                <div class="last-child-none" style="max-height: 858px;" data-simplebar>
                    <div class="p-20 border-bottom child">
                        <h4 class="fs-15 fw-medium mb-12">RTL Mode</h4>
                        <div class="rtl-btn">
                            <label id="switch">
                                <input type="checkbox" onchange="toggleTheme()" class="toggle-switch rtl-switch" id="slider">
                            </label>
                        </div>
                    </div>
                    <div class="p-20 border-bottom child">
                        <h4 class="fs-15 fw-medium mb-12">Only Sidebar Dark</h4>
                        <div class="sidebar-light-dark" id="sidebar-light-dark">
                            <input type="checkbox" class="toggle-switch sidebar-dark-switch">
                        </div>
                    </div>
                    <div class="p-20 border-bottom child">
                        <h4 class="fs-15 fw-medium mb-12">Only Header Dark</h4>
                        <div class="header-light-dark" id="header-light-dark">
                            <input type="checkbox" class="toggle-switch header-dark-switch">
                        </div>
                    </div>
                    <div class="p-20 border-bottom child">
                        <h4 class="fs-15 fw-medium mb-12">Right Sidebar</h4>
                        <div class="right-sidebar" id="right-sidebar">
                            <input type="checkbox" class="toggle-switch right-sidebar-switch">
                        </div>
                    </div>
                    <div class="p-20 border-bottom child">
                        <h4 class="fs-15 fw-medium mb-12">Hide Sidebar</h4>
                        <div class="icon-sidebar" id="icon-sidebar">
                            <input type="checkbox" class="toggle-switch icon-sidebar-switch">
                        </div>
                    </div>
                    <div class="p-20 border-bottom child">
                        <h4 class="fs-15 fw-medium mb-12">Bordered Card</h4>
                        <div class="card-border" id="card-border">
                            <input type="checkbox" class="toggle-switch border-switch">
                        </div>
                    </div>
                    <div class="p-20 border-bottom child">
                        <h4 class="fs-15 fw-medium mb-12">Card Border Radius</h4>
                        <div class="card-radius-square" id="card-radius-square">
                            <input type="checkbox" class="toggle-switch border-radius-switch">
                        </div>
                    </div>
                    
                    <div class="p-20 border-bottom child">
                        <a href="#" class="btn btn-primary text-white">
                            Cloudignite
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Theme Setting Area -->
     
        <!-- Link Of JS File -->
        <script src="../assets/js/bootstrap.bundle.min.js"></script>
        <script src="../assets/js/sidebar-menu.js"></script>
        <script src="../assets/js/quill.min.js"></script>
        <script src="../assets/js/data-table.js"></script>
        <script src="../assets/js/prism.js"></script>
        <script src="../assets/js/clipboard.min.js"></script>
        <script src="../assets/js/simplebar.min.js"></script>
        <script src="../assets/js/apexcharts.min.js"></script>
        <script src="../assets/js/echarts.min.js"></script>
        <script src="../assets/js/swiper-bundle.min.js"></script>
        <script src="../assets/js/fullcalendar.main.js"></script>
        <script src="../assets/js/jsvectormap.min.js"></script>
        <script src="../assets/js/world-merc.js"></script>
        <script src="../assets/js/custom/apexcharts.js"></script>
        <script src="../assets/js/custom/echarts.js"></script>
        <script src="../assets/js/custom/maps.js"></script>
        <script src="../assets/js/config.js"></script>
        <script src="../assets/js/custom/custom.js"></script>
        <script src="../assets/js/auth/authService.js"></script>
        <script src="../assets/js/api/apiService.js"></script>
        <script src="../assets/js/sidebar/sidebarService.js"></script>
        
        
        <!-- Authentication Check -->
        <script>
            // Verify authentication on page load
            document.addEventListener('DOMContentLoaded', function() {
                if (window.authService) {
                    if (!window.authService.isAuthenticated()) {
                        window.location.href = 'sign-in.html';
                        return;
                    }
                    
                    // Optionally refresh user info
                    window.authService.getCurrentUserInfo().catch(err => {
                        console.warn('Could not refresh user info:', err);
                    });
                }
                // Owner View feature flag: hide nav link if disabled (503)
                (function checkOwnerViewFlag() {
                    var nav = document.getElementById('nav-owner-view');
                    if (!nav) return;
                    if (sessionStorage.getItem('ownerViewEnabled') === 'false') {
                        nav.style.display = 'none';
                        return;
                    }
                    if (!window.apiService) return;
                    window.apiService.getExecutiveSummary().then(function() {
                        sessionStorage.setItem('ownerViewEnabled', 'true');
                    }).catch(function(e) {
                        if (e && (e.status === 503 || e.code === 'FEATURE_DISABLED')) {
                            sessionStorage.setItem('ownerViewEnabled', 'false');
                            nav.style.display = 'none';
                        }
                    });
                })();
            });
        </script>
        <script>
            // Initialize database with data if empty (only once per session to avoid reload loop)
            (async function() {
                if (sessionStorage.getItem('dashboardSeededReload')) {
                    sessionStorage.removeItem('dashboardSeededReload');
                    return;
                }
                try {
                    const metricsResponse = await window.apiService.getDashboardMetrics('weekly');
                    const metrics = metricsResponse.data || metricsResponse;
                    if (metrics.weeklyLoss === 0 && metrics.foodCostPercentage === 0 && !metrics.sales) {
                        console.log('📊 Initializing database with sample data...');
                        try {
                            const base = (window.apiService && window.apiService.API_BASE_URL) || (window.APP_CONFIG && window.APP_CONFIG.API_BASE_URL) || 'http://localhost:8000/api';
                            const headers = { 'Content-Type': 'application/json' };
                            const token = window.authService && window.authService.getToken();
                            if (token) headers['Authorization'] = 'Bearer ' + token;
                            const initResult = await fetch(base + '/seed/initialize', { method: 'POST', headers });
                            const result = await initResult.json();
                            if (result.success) {
                                console.log('✅ Database initialized:', result.results);
                                sessionStorage.setItem('dashboardSeededReload', '1');
                                setTimeout(() => window.location.reload(), 2000);
                            } else console.warn('Seed failed:', result.error || result.message);
                        } catch (initError) {
                            console.warn('Could not initialize database:', initError);
                        }
                    }
                } catch (error) {
                    console.log('📊 Initializing database...');
                    try {
                        const base = (window.apiService && window.apiService.API_BASE_URL) || (window.APP_CONFIG && window.APP_CONFIG.API_BASE_URL) || 'http://localhost:8000/api';
                        const headers = { 'Content-Type': 'application/json' };
                        const token = window.authService && window.authService.getToken();
                        if (token) headers['Authorization'] = 'Bearer ' + token;
                        const initResult = await fetch(base + '/seed/initialize', { method: 'POST', headers });
                        const result = await initResult.json();
                        if (result.success) {
                            console.log('✅ Database initialized:', result.results);
                            sessionStorage.setItem('dashboardSeededReload', '1');
                            setTimeout(() => window.location.reload(), 2000);
                        } else console.warn('Seed failed:', result.error || result.message);
                    } catch (initError) {
                        console.warn('Could not initialize database:', initError);
                    }
                }
            })();

            window.currentDashboardPeriod = window.currentDashboardPeriod || 'weekly';

            async function loadDashboardMetrics(period) {
                if (period) window.currentDashboardPeriod = period;
                const p = window.currentDashboardPeriod;
                try {
                    const metricsResponse = await window.apiService.getDashboardMetrics(p);
                    const metrics = metricsResponse.data || metricsResponse;
                    window.lastDashboardMetrics = metrics;
                    renderDashboardMetrics(metrics);
                } catch (e) {
                    console.error('Dashboard metrics failed:', e);
                }
            }

            function renderDashboardMetrics(metrics) {
                    const weeklyLossEls = document.querySelectorAll('h2');
                    const defs = metrics.lossDefinitions || {};
                    const periodInfo = metrics.periodInfo || {};
                    const monthPeriodLabel = periodInfo.monthPeriodLabel || (metrics.period && metrics.period.label) || 'This period';
                    const monthDayCount = periodInfo.monthDayCount || (metrics.period && metrics.period.dayCount) || 0;
                    const wlVal = document.getElementById('weekly-loss-value');
                    const wlLabel = document.getElementById('weekly-loss-card-label');
                    const wlDisplay = metrics.weeklyLossDisplay;
                    const mlDisplay = metrics.monthlyLossDisplay;
                    const isProfit = metrics.isProfitable === true;
                    const amount = isProfit ? (metrics.grossProfit ?? 0) : (metrics.monthlyLoss ?? 0);
                    const sectionTitle = document.getElementById('loss-summary-section-title');
                    const sectionSubtitle = document.getElementById('loss-summary-section-subtitle');
                    if (sectionTitle) {
                        if (window.currentDashboardPeriod === 'monthly') sectionTitle.textContent = isProfit ? 'Monthly P&L' : '⚠️ Monthly Loss Alert';
                        else if (window.currentDashboardPeriod === 'quarterly') sectionTitle.textContent = isProfit ? 'Quarterly P&L' : '⚠️ Quarterly Loss Alert';
                        else sectionTitle.textContent = isProfit ? 'Weekly P&L' : '⚠️ Weekly Loss Alert';
                    }
                    if (sectionSubtitle && !isProfit && pa && pa.action && pa.action !== 'On track' && pa.impact > 0) {
                        const dailyStr = metrics.dailyBurnRate && metrics.dailyBurnRate.value != null ? 'Losing $' + Math.abs(metrics.dailyBurnRate.value).toFixed(0) + '/day. ' : '';
                        const issueStr = pa.title || pa.action;
                        sectionSubtitle.textContent = dailyStr + '#1 Issue: ' + issueStr;
                        sectionSubtitle.classList.remove('d-none');
                    } else if (sectionSubtitle) {
                        sectionSubtitle.classList.add('d-none');
                    }
                    if (wlVal) {
                        wlVal.textContent = (isProfit ? '' : '-') + '$' + Math.abs(amount).toLocaleString();
                        wlVal.title = 'Sales − (Food + Labor + Waste). ' + (isProfit ? 'Gross profit.' : 'Negative = gross loss.');
                        if (wlLabel) wlLabel.textContent = isProfit ? 'Gross Profit' : 'Gross Loss';
                        wlVal.classList.toggle('text-danger', !isProfit && (mlDisplay ? mlDisplay.isLoss : true));
                        wlVal.classList.toggle('text-success', isProfit || (mlDisplay && !mlDisplay.isLoss));
                    }
                    var lossSummaryPeriodBtn = document.getElementById('loss-summary-period-btn');
                    if (lossSummaryPeriodBtn) lossSummaryPeriodBtn.textContent = monthPeriodLabel;
                    var dailyBurn = metrics.dailyBurnRate && metrics.dailyBurnRate.value != null ? metrics.dailyBurnRate.value : 0;
                    var weeklyLossSub = document.getElementById('weekly-loss-subtitle');
                    if (weeklyLossSub) {
                        if (metrics.costs) {
                            weeklyLossSub.textContent = 'Sales $' + (metrics.sales || 0).toLocaleString() + ' − (Food $' + (metrics.costs.purchases || 0).toLocaleString() + ' + Labor $' + (metrics.costs.labor || 0).toLocaleString() + ' + Waste $' + (metrics.costs.waste || 0).toLocaleString() + ')';
                        } else if (!isProfit && dailyBurn < 0) {
                            weeklyLossSub.textContent = 'Losing $' + Math.abs(dailyBurn).toFixed(0) + '/day';
                        } else {
                            weeklyLossSub.textContent = 'Sales − (Food + Labor + Waste)';
                        }
                    }
                    var iconWrap = document.getElementById('weekly-loss-icon-wrap');
                    if (iconWrap) {
                        iconWrap.classList.toggle('bg-danger', !isProfit);
                        iconWrap.classList.toggle('bg-success', isProfit);
                    }
                    var pa = metrics.priorityAction;
                    var priorityBox = document.getElementById('priority-alert-box');
                    var priorityMsg = document.getElementById('priority-alert-message');
                    var prioritySteps = document.getElementById('priority-alert-steps');
                    if (priorityBox && pa && pa.action && pa.action !== 'On track' && pa.impact > 0) {
                        priorityBox.classList.remove('d-none');
                        if (priorityMsg) priorityMsg.textContent = (pa.title || pa.action) + (pa.issue ? ' — ' + pa.issue : '') + (pa.impactLabel ? ' ' + pa.impactLabel : '');
                        if (prioritySteps && pa.steps && pa.steps.length) {
                            prioritySteps.innerHTML = pa.steps.map(function(s) { return '<li>' + s + '</li>'; }).join('');
                        } else if (prioritySteps) prioritySteps.innerHTML = '';
                    } else if (priorityBox) priorityBox.classList.add('d-none');
                    
                    // Food Cost % – progressive disclosure (foodCostDisplay)
                    const fcDisplay = metrics.foodCostDisplay;
                    const foodCost = fcDisplay && fcDisplay.value != null ? fcDisplay.value : (metrics.foodCostPercentage ?? 34.2);
                    const fcVal = document.getElementById('food-cost-value');
                    const fcSub = document.getElementById('food-cost-subtitle');
                    if (fcVal) {
                        fcVal.textContent = fcDisplay && fcDisplay.message ? fcDisplay.message : (foodCost + '%');
                        fcVal.title = (fcDisplay && fcDisplay.tooltip) ? fcDisplay.tooltip : 'Food cost % (target 28–32%)';
                    } else {
                        weeklyLossEls.forEach(el => {
                            if (el.textContent.includes('34.2%')) el.textContent = foodCost + '%';
                        });
                    }
                    if (fcSub && fcDisplay) {
                        if (fcDisplay.confidence === 'none') {
                            fcSub.textContent = fcDisplay.dataRequirements || 'Add inventory or purchase data';
                        } else {
                            var overPts = foodCost > 28 ? (foodCost - 28) : 0;
                            var over = foodCost > 28 ? overPts.toFixed(1) + '% over target' : 'on target';
                            fcSub.textContent = 'Target: 28%. ' + (foodCost > 28 ? over : 'OK');
                        }
                    }
                    
                    // Monthly Loss (by selector if no ID)
                    weeklyLossEls.forEach(el => {
                        if (el.id === 'weekly-loss-value' || el.id === 'food-cost-value' || el.id === 'monthly-savings-amount' || el.id === 'prime-cost-value') return;
                        if (el.textContent.includes('$11,388')) el.textContent = '$' + (metrics.monthlyLoss ?? 0).toLocaleString();
                    });
                    
                    // Waste % – wasteDisplay
                    const wd = metrics.wasteDisplay;
                    const wastePct = wd && wd.value != null ? wd.value : (metrics.wastePercentage ?? 8.5);
                    const lw = document.getElementById('loss-overview-weekly');
                    const lm = document.getElementById('loss-overview-monthly');
                    const lwLbl = document.getElementById('loss-overview-weekly-label');
                    const lmLbl = document.getElementById('loss-overview-monthly-label');
                    const lwaste = document.getElementById('loss-overview-waste');
                    const lwasteBar = document.getElementById('loss-overview-waste-bar');
                    const lwasteTarget = document.getElementById('loss-overview-waste-target');
                    const wlD = metrics.weeklyLossDisplay;
                    const mlD = metrics.monthlyLossDisplay;
                    // Align with breakdown: when period is short, show one period label and same value in both slots; when full week/month, show weekly and monthly
                    var periodLabel = 'Loss (' + monthPeriodLabel + ')';
                    if (lw) {
                        lw.textContent = '$' + (monthDayCount >= 28 ? (metrics.weeklyLoss ?? 0) : (metrics.monthlyLoss ?? 0)).toLocaleString();
                        lw.title = defs.weeklyLoss || defs.monthlyLoss || '';
                    }
                    if (lwLbl) lwLbl.textContent = monthDayCount >= 28 ? (wlD && wlD.label ? wlD.label : 'Weekly Loss') : periodLabel;
                    if (lm) {
                        lm.textContent = '$' + (metrics.monthlyLoss ?? 0).toLocaleString();
                        lm.title = defs.monthlyLoss || '';
                    }
                    if (lmLbl) lmLbl.textContent = monthDayCount >= 28 ? (mlD && mlD.label ? mlD.label : 'Monthly Loss') : periodLabel;
                    if (lwaste) {
                        lwaste.textContent = (wd && wd.message) ? wd.message : (wastePct + '%');
                        lwaste.title = (wd && wd.tooltip) ? wd.tooltip : '';
                    }
                    if (lwasteBar) lwasteBar.style.width = Math.min(100, wastePct) + '%';
                    if (lwasteTarget) {
                        const wasteCurrent = (wd && wd.message) ? wd.message : (wd && wd.confidence !== 'none' ? wastePct + '%' : '');
                        lwasteTarget.textContent = 'Target waste: 5% of food cost.' + (wasteCurrent ? ' Current: ' + wasteCurrent : ' Add purchase & waste data.');
                    }
                    
                    // Labor Cost %
                    const laborCost = metrics.laborCostPercentage ?? 32.8;
                    const laborVal = document.getElementById('labor-cost-value');
                    const laborBadge = document.getElementById('labor-cost-badge');
                    const noFood = (metrics.foodCostDisplay && metrics.foodCostDisplay.confidence === 'none') || (foodCost == null && !metrics.foodCostPercentage);
                    if (laborVal) laborVal.textContent = laborCost + '%';
                    if (laborBadge) {
                        if (noFood) {
                            laborBadge.textContent = 'Prime low';
                            laborBadge.className = 'lh-1 fs-14 text-warning';
                            laborBadge.title = 'Food data missing. Prime below 55–65% target – check if all labor is recorded or if under-staffed.';
                        } else {
                            laborBadge.textContent = laborCost > 30 ? 'High' : 'OK';
                            laborBadge.className = 'lh-1 fs-14 ' + (laborCost > 30 ? 'text-danger' : 'text-success');
                            laborBadge.title = laborCost > 30 ? 'Labor above 30% target.' : 'Labor within target.';
                        }
                    }
                    
                    // Prime Cost – primeCostDisplay (handle food=0 / add data)
                    const pcDisplay = metrics.primeCostDisplay;
                    const primeCost = (pcDisplay && pcDisplay.value != null) ? pcDisplay.value : (metrics.primeCost ?? (foodCost + laborCost));
                    const primeEl = document.getElementById('prime-cost-value');
                    const primeBadge = document.getElementById('prime-cost-badge');
                    const primeStatus = document.getElementById('prime-cost-status');
                    if (primeEl) {
                        primeEl.textContent = (pcDisplay && pcDisplay.message) ? pcDisplay.message : (primeCost != null ? primeCost.toFixed(1) + '%' : '—');
                        primeEl.title = (pcDisplay && pcDisplay.tooltip) ? pcDisplay.tooltip : 'Food % + Labor %. Target 55–65%.';
                    }
                    if (primeBadge) {
                        primeBadge.textContent = (foodCost != null ? 'Food ' + foodCost + '%' : 'Food —') + ' + Labor ' + laborCost + '%';
                        const primeCritical = pcDisplay && pcDisplay.isCritical;
                        const primeOk = primeCost != null && primeCost >= 55 && primeCost <= 65;
                        primeBadge.className = 'badge ' + (primeCritical ? 'bg-danger' : primeOk ? 'bg-success' : (primeCost != null ? 'bg-warning' : 'bg-secondary'));
                    }
                    if (primeStatus) {
                        const primeCritical = pcDisplay && pcDisplay.isCritical;
                        if (primeCritical)
                            primeStatus.textContent = 'Critical: Prime Cost over 100% — restaurant is spending more on food and labor than it makes in sales. Unsustainable. Reduce costs or increase sales immediately.';
                        else if (primeCost == null || noFood)
                            primeStatus.textContent = 'Prime Cost too low (' + (primeCost != null ? primeCost.toFixed(1) : '?') + '% vs 55–65% target). Check if all labor is recorded or if under-staffed. Add food cost data to assess fully.';
                        else if (primeCost < 55)
                            primeStatus.textContent = 'Under target (55–65%). Check if all labor is recorded or if under-staffed.';
                        else if (primeCost <= 65)
                            primeStatus.textContent = 'Within target (55–65%).';
                        else
                            primeStatus.textContent = 'Above target. Reduce food or labor cost to improve profitability.';
                    }
                    
                    // Biggest Loss Source – only show real data; otherwise "—" to match Top 5 Loss Sources
                    const blCat = document.getElementById('biggest-loss-category');
                    const blAmt = document.getElementById('biggest-loss-amount');
                    const blPeriod = document.getElementById('biggest-loss-period');
                    const blLink = document.getElementById('biggest-loss-link');
                    var periodLabelSpan = (metrics.periodInfo && metrics.periodInfo.monthPeriodLabel) ? metrics.periodInfo.monthPeriodLabel : 'This Month';
                    if (blCat && blAmt) {
                        var topLossFromBreakdown = (metrics.savingsBreakdown && metrics.savingsBreakdown.items && metrics.savingsBreakdown.items.length > 0)
                            ? metrics.savingsBreakdown.items.reduce(function(best, it) {
                                var amt = Math.abs(it.monthlyImpact || it.currentCost || 0);
                                return amt > (best.amount || 0) ? { category: it.category, amount: amt } : best;
                              }, { category: '', amount: 0 })
                            : null;
                        if (topLossFromBreakdown && topLossFromBreakdown.amount > 0) {
                            blCat.textContent = topLossFromBreakdown.category || 'Food Cost';
                            blCat.classList.remove('text-muted');
                            blCat.classList.add('text-danger');
                            blAmt.innerHTML = '$' + topLossFromBreakdown.amount.toLocaleString() + '<span class="fs-16 text-body" id="biggest-loss-period">(' + periodLabelSpan + ')</span>';
                            if (blLink) { blLink.style.display = ''; blLink.href = 'analytics.html'; blLink.textContent = 'View Details'; }
                        } else if (metrics.biggestLossSource && metrics.biggestLossSource.total_waste > 0) {
                            blCat.textContent = metrics.biggestLossSource.category || 'Food Waste';
                            blCat.classList.remove('text-muted');
                            blCat.classList.add('text-danger');
                            blAmt.innerHTML = '$' + metrics.biggestLossSource.total_waste.toLocaleString() + '<span class="fs-16 text-body" id="biggest-loss-period">(' + periodLabelSpan + ')</span>';
                            if (blLink) { blLink.style.display = ''; blLink.href = 'analytics.html'; blLink.textContent = 'View Details'; }
                        } else {
                            blCat.textContent = 'No data';
                            blCat.classList.remove('text-danger');
                            blCat.classList.add('text-muted');
                            if (blPeriod) blPeriod.textContent = '';
                            blAmt.innerHTML = '—<span class="fs-16 text-body">(Add purchase &amp; waste data)</span>';
                            if (blLink) { blLink.style.display = ''; blLink.href = 'manual-data-entry.html'; blLink.textContent = 'Manual Data Entry → Invoice upload'; }
                        }
                    }
                    
                    // "If Fixed" / Savings – savingsDisplay (Loss vs Gain)
                    const svDisplay = metrics.savingsDisplay;
                    const monthlySavingsEl = document.getElementById('monthly-savings-amount');
                    const monthlySavingsBadge = document.getElementById('monthly-savings-badge');
                    const savingsLabel = document.getElementById('savings-card-label');
                    const savingsTooltip = document.getElementById('savings-card-tooltip');
                    if (svDisplay && svDisplay.label && savingsLabel) savingsLabel.textContent = svDisplay.label;
                    if (savingsTooltip && svDisplay && svDisplay.tooltip) savingsTooltip.textContent = svDisplay.tooltip;
                    if (monthlySavingsEl && (metrics.ifFixedMonthlySavings !== undefined || metrics.grossProfit !== undefined)) {
                        const lossAmt = metrics.monthlyIsLoss ? (Math.abs(metrics.grossProfit ?? metrics.ifFixedMonthlySavings ?? 0)) : 0;
                        monthlySavingsEl.textContent = metrics.monthlyIsLoss ? '-$' + lossAmt.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : (metrics.grossProfit != null && metrics.grossProfit > 0 ? '$' + metrics.grossProfit.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '—');
                        monthlySavingsEl.title = (svDisplay && svDisplay.tooltip) ? svDisplay.tooltip : 'Sales − (Food + Labor + Waste). Negative = loss.';
                        monthlySavingsEl.classList.toggle('text-danger', metrics.monthlyIsLoss);
                        monthlySavingsEl.classList.toggle('text-success', !metrics.monthlyIsLoss && (metrics.grossProfit || 0) > 0);
                        if (monthlySavingsBadge) {
                            if (metrics.monthlyIsLoss && lossAmt > 0) {
                                const k = (lossAmt / 1000).toFixed(1);
                                monthlySavingsBadge.textContent = k >= 1 ? '-$' + k + 'K' : '-$' + lossAmt.toFixed(0);
                            } else if (!metrics.monthlyIsLoss && (metrics.grossProfit || 0) > 0) {
                                monthlySavingsBadge.textContent = '$' + ((metrics.grossProfit || 0) / 1000).toFixed(1) + 'K';
                            } else {
                                monthlySavingsBadge.textContent = '—';
                            }
                        }
                    }
                    
                    // Loss by Category: period label and dropdown
                    var lossByCatPeriod = document.getElementById('loss-by-category-period');
                    var lossByCatPeriodBtn = document.getElementById('loss-by-category-period-btn');
                    if (lossByCatPeriod) lossByCatPeriod.textContent = metrics.periodInfo && metrics.periodInfo.monthPeriodLabel ? '(' + metrics.periodInfo.monthPeriodLabel + ')' : '';
                    if (lossByCatPeriodBtn) lossByCatPeriodBtn.textContent = (metrics.periodInfo && metrics.periodInfo.monthPeriodLabel) ? metrics.periodInfo.monthPeriodLabel : 'Period';

                    // Top 5 Loss Sources & Cost Breakdown: same period as main analysis
                    var topLossPeriodBtn = document.getElementById('top-loss-sources-period-btn');
                    var costBreakdownPeriodBtn = document.getElementById('cost-breakdown-period-btn');
                    var topLossNote = document.getElementById('top-loss-sources-period-note');
                    if (topLossPeriodBtn) topLossPeriodBtn.textContent = monthPeriodLabel;
                    if (costBreakdownPeriodBtn) costBreakdownPeriodBtn.textContent = monthPeriodLabel;
                    if (topLossNote) topLossNote.textContent = 'Showing top 5 loss sources (' + monthPeriodLabel + ')';

                    // Highest Cost Inventory & Revenue: when period is short use same period label
                    var invPeriodBtn = document.getElementById('highest-cost-inventory-period-btn');
                    if (invPeriodBtn) invPeriodBtn.textContent = (monthDayCount < 7 ? monthPeriodLabel : (metrics.periodInfo && metrics.periodInfo.weekPeriodLabel) || 'This Week');

                    // Loss by Category total (sum of breakdown items)
                    const lossByCategoryEl = document.getElementById('loss-by-category-total');
                    if (lossByCategoryEl && metrics.savingsBreakdown && metrics.savingsBreakdown.items) {
                        const totalLoss = metrics.savingsBreakdown.items.reduce((sum, item) => sum + Math.abs(item.monthlyImpact || item.currentCost || 0), 0);
                        if (totalLoss > 0) {
                            const k = (totalLoss / 1000).toFixed(1);
                            lossByCategoryEl.textContent = '$' + k + 'K';
                        } else {
                            lossByCategoryEl.textContent = '—';
                        }
                    } else if (lossByCategoryEl) {
                        lossByCategoryEl.textContent = '—';
                    }
                    
                    // Cost Breakdown by Category – hide 42%/28%/30% when no data
                    const cbcWaste = document.getElementById('cost-breakdown-waste');
                    const cbcLabor = document.getElementById('cost-breakdown-labor');
                    const cbcInv = document.getElementById('cost-breakdown-inv');
                    const cbcEmpty = document.getElementById('cost-breakdown-empty');
                    const cbcChart = document.getElementById('order_summary_chart');
                    const hasPurchases = (metrics.savingsBreakdown && metrics.savingsBreakdown.calculation && (metrics.savingsBreakdown.calculation.totalPurchases || 0) > 0);
                    const hasBreakdownItems = (metrics.savingsBreakdown && metrics.savingsBreakdown.items && metrics.savingsBreakdown.items.length > 0);
                    var purchaseBanner = document.getElementById('purchase-data-missing-banner');
                    if (purchaseBanner) purchaseBanner.classList.toggle('d-none', !!hasPurchases);
                    if (cbcWaste && cbcLabor && cbcInv) {
                        if (!hasPurchases || !hasBreakdownItems) {
                            cbcWaste.textContent = '—';
                            cbcLabor.textContent = '—';
                            cbcInv.textContent = '—';
                            if (cbcEmpty) { cbcEmpty.style.display = 'block'; }
                            if (cbcChart) { cbcChart.style.display = 'none'; }
                        } else {
                            const byCat = {};
                            (metrics.savingsBreakdown.items || []).forEach(function(it) {
                                const c = (it.category || 'Other').trim();
                                if (!byCat[c]) byCat[c] = 0;
                                byCat[c] += Math.abs(it.monthlyImpact || it.currentCost || 0);
                            });
                            const total = Object.values(byCat).reduce(function(s, v) { return s + v; }, 0) || 1;
                            const waste = Math.round(((byCat['Waste'] || 0) / total) * 100);
                            const labor = Math.round(((byCat['Labor'] || 0) / total) * 100);
                            const inv = Math.round((((byCat['Inventory'] || 0) + (byCat['Variance'] || 0) + (byCat['Menu'] || 0) + (byCat['Food Cost'] || 0)) / total) * 100);
                            cbcWaste.textContent = waste ? 'Food Waste ' + waste + '%' : '—';
                            cbcLabor.textContent = labor ? 'Labor ' + labor + '%' : '—';
                            cbcInv.textContent = inv ? 'Inventory ' + inv + '%' : '—';
                            if (cbcEmpty) cbcEmpty.style.display = 'none';
                            if (cbcChart) cbcChart.style.display = '';
                        }
                    }

                    // Revenue: when period is short show same period as main analysis (e.g. "Last 2 Days: $746.70")
                    var revLabel = document.getElementById('revenue-this-week-label');
                    var revPeriodBtn = document.getElementById('revenue-period-btn');
                    var revPeriod = monthDayCount < 7 ? monthPeriodLabel : (metrics.periodInfo && metrics.periodInfo.weekPeriodLabel) || 'This Week';
                    var revAmount = monthDayCount < 7 ? (metrics.monthlySales != null ? metrics.monthlySales : 0) : (metrics.weeklySales != null ? metrics.weeklySales : 0);
                    if (revLabel) revLabel.textContent = revPeriod + ': $' + (revAmount || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    if (revPeriodBtn) revPeriodBtn.textContent = revPeriod;

                    // Loss by Category chart – sync with Top 5 Loss Sources (donut from API data)
                    var profitChartEl = document.getElementById('profit_chart');
                    if (profitChartEl && metrics.lossByCategory && metrics.lossByCategory.length > 0 && typeof ApexCharts !== 'undefined') {
                        if (window.dashboardProfitChart) { try { window.dashboardProfitChart.destroy(); } catch (e) {} window.dashboardProfitChart = null; }
                        profitChartEl.innerHTML = '';
                        var lossChart = new ApexCharts(profitChartEl, {
                            chart: { type: 'donut', height: 224 },
                            series: metrics.lossByCategory.map(function(c) { return c.value; }),
                            labels: metrics.lossByCategory.map(function(c) { return c.name; }),
                            colors: ['#dc3545', '#fd7e14', '#ffc107', '#796df6', '#00cae3'],
                            legend: { position: 'bottom' },
                            dataLabels: { enabled: true },
                            plotOptions: { pie: { donut: { size: '65%' } } }
                        });
                        lossChart.render();
                        window.dashboardProfitChart = lossChart;
                    }

                    // Revenue chart – populate with weekly sales by day when available
                    if (metrics.weeklySalesByDay && metrics.weeklySalesByDay.length > 0 && window.dashboardRevenueChart) {
                        try {
                            window.dashboardRevenueChart.updateOptions({
                                series: [{ name: 'Revenue', data: metrics.weeklySalesByDay.map(function(d) { return d.total; }) }],
                                xaxis: { categories: metrics.weeklySalesByDay.map(function(d) { return d.dayName; }) }
                            });
                        } catch (e) { console.warn('Revenue chart update failed:', e); }
                    }
            }

            (async function() {
                try {
                    await loadDashboardMetrics('weekly');
                } catch (e) {
                    console.warn('Dashboard metrics load failed:', e);
                }
                var periodDropdown = document.querySelector('#loss-summary-period-btn + .dropdown-menu, [id="loss-summary-period-btn"] ~ .dropdown-menu');
                var periodBtns = document.querySelectorAll('.dropdown-menu [data-period]');
                if (periodBtns.length === 0) periodBtns = document.querySelectorAll('#loss-summary-period-btn ~ ul [data-period]');
                periodBtns.forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        var p = this.getAttribute('data-period');
                        if (p) loadDashboardMetrics(p);
                    });
                });
            })();

            // Load Action Items
            (async function() {
                const actionItemsList = document.getElementById('action-items-list');
                const actionItemsCount = document.getElementById('action-items-count');
                const actionItemsSubtitle = document.getElementById('action-items-subtitle');
                const actionItemsBadge = document.getElementById('action-items-badge');
                const badgeNum = document.getElementById('action-items-badge-num');
                if (!actionItemsList) return;
                
                try {
                    const response = await window.apiService.getActionItems();
                    const raw = response.data || response || {};
                    const items = Array.isArray(raw.items) ? raw.items : (Array.isArray(raw) ? raw : []);
                    
                    if (items.length === 0) {
                        actionItemsList.innerHTML = '<li class="text-center text-muted py-3"><i class="material-symbols-outlined me-2">check_circle</i>No action items. All metrics are within target.</li>';
                        if (actionItemsCount) actionItemsCount.textContent = '0 Issues';
                        if (actionItemsSubtitle) actionItemsSubtitle.textContent = 'All clear';
                        if (actionItemsBadge) {
                            actionItemsBadge.className = 'd-flex align-content-center gap-1 bg-success bg-opacity-10 border border-success';
                            const i = actionItemsBadge.querySelector('i');
                            if (i) { i.className = 'material-symbols-outlined fs-14 text-success'; i.textContent = 'check_circle'; }
                            if (badgeNum) { badgeNum.className = 'lh-1 fs-14 text-success'; badgeNum.textContent = '0'; }
                        }
                    } else {
                        const linkMap = { 'Food Cost': 'analytics.html', 'Waste': 'analytics.html', 'Labor': 'reports.html', 'Inventory': 'inventory-count.html', 'Variance': 'analytics.html' };
                        const typeMap = { 'Food Cost': 'foodcost', 'Waste': 'waste', 'Labor': 'labor', 'Inventory': 'inventory', 'Variance': 'variance' };
                        actionItemsList.innerHTML = items.slice(0, 3).map((item, idx) => {
                            const link = linkMap[item.category] || 'analytics.html';
                            const type = typeMap[item.category] || 'foodcost';
                            return `<li class="mb-2 action-item-fix cursor-pointer" data-loss-type="${type}" data-amount="${item.impact === 'High' ? 1000 : 500}" data-link="${link}" role="button" tabindex="0">
                                <span class="fs-14 text-body hover-text">${idx + 1}. ${item.title} — How to fix</span>
                            </li>`;
                        }).join('') + '<li><a href="analytics.html" class="fw-medium fs-14 text-primary hover-text">View All →</a></li>';
                        if (actionItemsCount) actionItemsCount.textContent = items.length + ' Issue' + (items.length !== 1 ? 's' : '');
                        if (actionItemsSubtitle) actionItemsSubtitle.textContent = 'Require Attention';
                        if (actionItemsBadge) {
                            actionItemsBadge.className = 'd-flex align-content-center gap-1 bg-danger bg-opacity-10 border border-danger';
                            const i = actionItemsBadge.querySelector('i');
                            if (i) { i.className = 'material-symbols-outlined fs-14 text-danger'; i.textContent = 'warning'; }
                            if (badgeNum) { badgeNum.className = 'lh-1 fs-14 text-danger'; badgeNum.textContent = String(items.length); }
                        }
                    }
                } catch (error) {
                    console.warn('⚠️ Action items unavailable:', error.message);
                    actionItemsList.innerHTML = '<li class="text-center text-muted py-3"><i class="material-symbols-outlined me-2">info</i>Unable to load action items. Check backend is running.</li>';
                    if (actionItemsCount) actionItemsCount.textContent = '—';
                    if (actionItemsSubtitle) actionItemsSubtitle.textContent = 'Check connection';
                    if (actionItemsBadge) {
                        actionItemsBadge.className = 'd-flex align-content-center gap-1 bg-secondary bg-opacity-10 border border-secondary';
                        const i = actionItemsBadge.querySelector('i');
                        if (i) { i.className = 'material-symbols-outlined fs-14 text-secondary'; i.textContent = 'info'; }
                        if (badgeNum) { badgeNum.className = 'lh-1 fs-14 text-secondary'; badgeNum.textContent = '—'; }
                    }
                }
            })();

            // Load Top 5 Loss Sources (from savings breakdown) – use current period
            (async function() {
                const tbody = document.getElementById('top-loss-sources-tbody');
                if (!tbody) return;
                try {
                    const period = window.currentDashboardPeriod || 'weekly';
                    const metricsResponse = await window.apiService.getDashboardMetrics(period);
                    const metrics = metricsResponse.data || metricsResponse;
                    const breakdown = metrics.savingsBreakdown;
                    
                    if (!breakdown || !breakdown.items || breakdown.items.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4"><i class="material-symbols-outlined me-2">info</i>No loss sources identified. Add purchase and waste data to identify cost issues.</td></tr>';
                    } else {
                        const iconMap = {
                            'Waste': { icon: 'delete', color: 'text-danger' },
                            'Food Cost': { icon: 'restaurant', color: 'text-warning' },
                            'Labor': { icon: 'groups', color: 'text-warning' },
                            'Inventory': { icon: 'local_shipping', color: 'text-warning' },
                            'Variance': { icon: 'compare_arrows', color: 'text-info' },
                            'Menu': { icon: 'restaurant_menu', color: 'text-info' }
                        };
                        const linkMap = {
                            'Waste': 'analytics.html',
                            'Food Cost': 'analytics.html',
                            'Labor': 'reports.html',
                            'Inventory': 'products-list.html',
                            'Variance': 'analytics.html',
                            'Menu': 'products-list.html'
                        };
                        const typeMap = {
                            'Waste': 'waste',
                            'Food Cost': 'foodcost',
                            'Labor': 'labor',
                            'Inventory': 'supplier',
                            'Variance': 'variance',
                            'Menu': 'menu'
                        };
                        
                        tbody.innerHTML = breakdown.items.slice(0, 5).map((item, idx) => {
                            const iconInfo = iconMap[item.category] || { icon: 'warning', color: 'text-warning' };
                            const link = linkMap[item.category] || 'analytics.html';
                            const type = typeMap[item.category] || 'waste';
                            return `<tr class="guided-fix-row" data-loss-type="${type}" data-amount="${Math.abs(item.monthlyImpact || item.currentCost || 0)}" data-desc="${item.recommendation || item.issue || ''}" data-link="${link}">
                                <td class="text-body fw-medium">${String(idx + 1).padStart(2, '0')}.</td>
                                <td class="ps-0">
                                    <div class="d-flex align-items-center">
                                        <span class="material-symbols-outlined ${iconInfo.color}" style="font-size: 40px;">${iconInfo.icon}</span>
                                        <div class="flex-grow-1 ms-12">
                                            <h3 class="fw-normal mb-0">${item.issue || item.title || 'Unknown Issue'}</h3>
                                            <span class="fs-14 text-body fw-normal">${item.recommendation || item.description || ''}</span>
                                        </div>
                                    </div>
                                </td>
                                <td class="text-body">Category: ${item.category || 'Other'}</td>
                                <td class="text-danger fw-medium">-$${Math.abs(item.monthlyImpact || item.currentCost || 0).toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</td>
                                <td class="text-end"><button type="button" class="btn btn-sm btn-outline-primary guided-fix-btn">How to fix</button></td>
                            </tr>`;
                        }).join('');
                    }
                } catch (error) {
                    console.warn('⚠️ Loss sources unavailable:', error.message);
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4"><i class="material-symbols-outlined me-2">info</i>Unable to load loss sources. Add purchase and waste data to identify cost issues.</td></tr>';
                }
            })();

            // Load Highest Cost Inventory Items (from invoices/purchase items, or inventory as fallback)
            (async function() {
                const tbody = document.getElementById('inventory-items-table-body');
                if (!tbody) return;
                
                function renderTopItems(topItems) {
                    if (topItems.length > 0) {
                        tbody.innerHTML = topItems.map((item, index) => `
                            <tr ${index === topItems.length - 1 ? 'class="last-child-border-none"' : ''}>
                                <td class="text-body fw-medium">${String(index + 1).padStart(2, '0')}.</td>
                                <td class="ps-0">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-shrink-0">
                                            <div class="text-primary text-center rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px; background-color: #dbeafd;">
                                                <i class="ri-box-3-line fs-24 text-primary"></i>
                                            </div>
                                        </div>
                                        <div class="flex-grow-1 ms-12">
                                            <h3 class="fw-normal mb-0">${item.name}</h3>
                                            <span class="fs-14 text-body fw-normal">Qty: ${(item.quantity || 0).toFixed(1)}</span>
                                        </div>
                                    </div>
                                </td>
                                <td class="text-end">
                                    <span class="fw-medium text-danger">$${(item.totalCost || 0).toFixed(2)}</span>
                                </td>
                            </tr>
                        `).join('');
                        return true;
                    }
                    return false;
                }
                
                try {
                    const invoicesResponse = await window.apiService.getInvoices();
                    const data = invoicesResponse.data || invoicesResponse;
                    const invoices = Array.isArray(data?.invoices) ? data.invoices : (Array.isArray(data) ? data : []);
                    const itemsMap = {};
                    
                    // Group items by name and sum costs from purchase_items
                    invoices.forEach(inv => {
                        const itemList = inv.items || inv.purchase_items || [];
                        if (Array.isArray(itemList) && itemList.length > 0) {
                            itemList.forEach(item => {
                                const key = (item.item_name || item.itemName || 'Unknown').trim();
                                if (!key) return;
                                if (!itemsMap[key]) {
                                    itemsMap[key] = { name: key, totalCost: 0, quantity: 0, unitPrice: item.unit_price || item.unitPrice || 0 };
                                }
                                const total = item.total_price ?? item.totalPrice ?? (item.unit_price || item.unitPrice || 0) * (item.quantity || 1);
                                itemsMap[key].totalCost += Number(total);
                                itemsMap[key].quantity += Number(item.quantity || 1);
                            });
                        }
                    });
                    
                    let topItems = Object.values(itemsMap)
                        .sort((a, b) => b.totalCost - a.totalCost)
                        .slice(0, 6);
                    
                    if (renderTopItems(topItems)) return;
                    
                    // Fallback: use inventory API (highest cost = quantity * unit_price)
                    try {
                        const invResponse = await window.apiService.getInventory({ limit: 100 });
                        const invData = invResponse.data || invResponse;
                        const list = Array.isArray(invData?.items) ? invData.items : (Array.isArray(invData) ? invData : []);
                        const fromInventory = list
                            .map(i => ({
                                name: i.itemName || i.item_name || 'Unknown',
                                totalCost: Number(i.totalValue ?? (i.quantity || 0) * (i.unitPrice || i.unit_price || 0)),
                                quantity: Number(i.quantity || 0)
                            }))
                            .filter(i => i.totalCost > 0)
                            .sort((a, b) => b.totalCost - a.totalCost)
                            .slice(0, 6);
                        
                        if (renderTopItems(fromInventory)) return;
                    } catch (invErr) {
                        console.warn('Inventory fallback failed:', invErr);
                    }
                    
                    tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4"><div class="text-muted mb-3">No inventory data available.</div><p class="fs-14 mb-2">To start saving, we need your inventory.</p><a href="manual-data-entry.html" class="btn btn-sm btn-primary">5‑minute setup: upload 3 invoices</a><p class="fs-13 text-muted mt-2 mb-0">Manual Data Entry → Invoice upload</p></td></tr>';
                } catch (error) {
                    console.warn('Error loading inventory items:', error);
                    tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4"><div class="text-muted mb-3">No inventory data available.</div><p class="fs-14 mb-2">To start saving, we need your inventory.</p><a href="manual-data-entry.html" class="btn btn-sm btn-primary">5‑minute setup: upload 3 invoices</a><p class="fs-13 text-muted mt-2 mb-0">Manual Data Entry → Invoice upload</p></td></tr>';
                }
            })();

            // Load Top Suppliers
            (async function() {
                try {
                    const startDate = new Date();
                    startDate.setMonth(startDate.getMonth() - 3);
                    const endDate = new Date();
                    
                    const suppliersResponse = await window.apiService.getSupplierRanking(
                        startDate.toISOString().split('T')[0],
                        endDate.toISOString().split('T')[0]
                    );
                    const suppliers = suppliersResponse.data || suppliersResponse; // Support both formats
                    
                    const list = document.getElementById('top-suppliers-list');
                    if (list && suppliers.suppliers && suppliers.suppliers.length > 0) {
                        const topSuppliers = suppliers.suppliers.slice(0, 6);
                        list.innerHTML = topSuppliers.map(supplier => `
                            <li class="d-flex align-items-center justify-content-between gap-2 mb-9 p-2 rounded" style="background-color: #f8f9fa;">
                                <div class="d-flex align-items-center gap-2">
                                    <div class="text-primary text-center rounded-circle d-flex align-items-center justify-content-center" style="width: 30px; height: 30px; background-color: #dbeafd;">
                                        <i class="ri-store-line fs-16 text-primary"></i>
                                    </div>
                                    <span class="fs-15 fw-medium">${supplier.vendor}</span>
                                </div>
                                <div class="text-end">
                                    <span class="fs-15 fw-bold text-danger">$${supplier.totalSpent.toFixed(2)}</span>
                                    <span class="fs-12 text-secondary d-block">${supplier.percentageOfTotal.toFixed(1)}%</span>
                                </div>
                            </li>
                        `).join('');
                    } else if (list) {
                        list.innerHTML = '<li class="text-center text-muted py-4">No supplier data available.</li>';
                    }
                } catch (error) {
                    console.warn('Error loading suppliers:', error);
                }
            })();

            // Load Recent Cost Issues
            (async function() {
                try {
                    const [wasteResponse, invoicesResponse] = await Promise.all([
                        window.apiService.getWasteRecords(),
                        window.apiService.getInvoices()
                    ]);
                    const wasteRaw = wasteResponse.data?.wasteRecords || wasteResponse.data || wasteResponse;
                    const invRaw = invoicesResponse.data?.invoices || invoicesResponse.data || invoicesResponse;
                    const wasteRecords = Array.isArray(wasteRaw) ? wasteRaw : [];
                    const invoices = Array.isArray(invRaw) ? invRaw : [];
                    
                    const issues = [];
                    
                    // Add waste issues
                    wasteRecords.slice(0, 3).forEach(waste => {
                        issues.push({
                            id: `WASTE-${waste.id}`,
                            category: 'Waste',
                            date: waste.waste_date,
                            lossAmount: waste.cost_value,
                            impact: 'High',
                            status: 'Active'
                        });
                    });
                    
                    // Add high cost invoices as issues
                    const highCostInvoices = invoices
                        .filter(inv => inv.total_amount > 500)
                        .slice(0, 2);
                    
                    highCostInvoices.forEach(inv => {
                        issues.push({
                            id: `INV-${inv.id}`,
                            category: 'Purchase',
                            date: inv.purchase_date,
                            lossAmount: inv.total_amount,
                            impact: 'Medium',
                            status: 'Recorded'
                        });
                    });
                    
                    issues.sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    const tbody = document.getElementById('cost-issues-table-body');
                    if (tbody && issues.length > 0) {
                        tbody.innerHTML = issues.map(issue => {
                            const date = new Date(issue.date);
                            const statusClass = issue.status === 'Active' ? 'warning' : issue.status === 'Recorded' ? 'success' : 'primary';
                            const statusText = issue.status === 'Active' ? 'Active' : issue.status === 'Recorded' ? 'Recorded' : 'Pending';
                            
                            return `
                                <tr>
                                    <td class="text-body">${issue.id}</td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="flex-shrink-0">
                                                <div class="text-${statusClass} text-center rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; background-color: ${statusClass === 'warning' ? '#fff4e8' : statusClass === 'success' ? '#e0f8ea' : '#dbeafd'};">
                                                    <i class="material-symbols-outlined fs-20">${issue.category === 'Waste' ? 'delete' : 'local_shipping'}</i>
                                                </div>
                                            </div>
                                            <div class="flex-grow-1 ms-12">
                                                <h3 class="fw-medium mb-0 fs-16">${issue.category}</h3>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-body">${date.toLocaleDateString()}</td>
                                    <td class="text-danger fw-medium">$${issue.lossAmount.toFixed(2)}</td>
                                    <td class="text-body">${issue.impact}</td>
                                    <td>
                                        <span class="text-${statusClass} bg-${statusClass} bg-opacity-10 fs-15 fw-normal d-inline-block default-badge">${statusText}</span>
                                    </td>
                                    <td>
                                        <div class="d-flex justify-content-end" style="gap: 12px;">
                                            <button class="bg-transparent p-0 border-0" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="View">
                                                <i class="material-symbols-outlined fs-16 fw-normal text-primary">visibility</i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('');
                    } else if (tbody) {
                        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">No cost issues found.</td></tr>';
                    }
                } catch (error) {
                    console.warn('Error loading cost issues:', error);
                }
            })();

            // Load Recently Captured Data (POS reports, invoices, waste) – same as Manual Data Entry
            (async function() {
                try {
                    const [posReportsResponse, invoicesResponse, wasteRecordsResponse] = await Promise.all([
                        window.apiService.getPOSReports(),
                        window.apiService.getInvoices(),
                        window.apiService.getWasteRecords()
                    ]);
                    
                    const posReports = posReportsResponse?.data?.reports || posReportsResponse?.data || posReportsResponse || [];
                    const invoices = invoicesResponse?.data?.invoices || invoicesResponse?.data || invoicesResponse || [];
                    const wasteRecords = wasteRecordsResponse?.data?.wasteRecords || wasteRecordsResponse?.data || wasteRecordsResponse || [];
                    
                    const posArray = Array.isArray(posReports) ? posReports : [];
                    const invArray = Array.isArray(invoices) ? invoices : [];
                    const wasteArray = Array.isArray(wasteRecords) ? wasteRecords : [];
                    
                    const rows = [];
                    
                    invArray.forEach(inv => {
                        rows.push({
                            type: 'Receipt',
                            typeBadge: 'primary',
                            date: inv.purchase_date,
                            description: `${inv.vendor || 'Vendor'} - ${inv.invoice_number || 'N/A'}`,
                            amount: inv.total_amount,
                            status: 'Processed'
                        });
                    });
                    
                    posArray.forEach(pos => {
                        rows.push({
                            type: 'POS Report',
                            typeBadge: 'info',
                            date: pos.report_date,
                            description: 'Daily Sales Report',
                            amount: pos.total_sales,
                            status: 'Processed'
                        });
                    });
                    
                    wasteArray.forEach(w => {
                        rows.push({
                            type: 'Waste',
                            typeBadge: 'danger',
                            date: w.waste_date,
                            description: `${w.item_name || 'Item'}${w.reason ? ' - ' + w.reason : ''}`,
                            amount: w.cost_value,
                            status: 'Recorded'
                        });
                    });
                    
                    rows.sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    const tbody = document.getElementById('cost-transactions-table-body');
                    const showingEl = document.getElementById('recent-captures-showing');
                    
                    if (tbody) {
                        if (rows.length > 0) {
                            tbody.innerHTML = rows.map(r => {
                                const d = new Date(r.date);
                                return `
                                    <tr>
                                        <td><span class="badge bg-${r.typeBadge}">${r.type}</span></td>
                                        <td class="text-body">${d.toLocaleDateString()}</td>
                                        <td class="text-body">${r.description}</td>
                                        <td class="fw-medium">$${Number(r.amount).toFixed(2)}</td>
                                        <td><span class="badge bg-success">${r.status}</span></td>
                                        <td><a href="manual-data-entry.html" class="text-primary"><i class="ri-eye-line"></i></a></td>
                                    </tr>
                                `;
                            }).join('');
                        } else {
                            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4"><div class="text-muted mb-2">No captured data yet.</div><a href="manual-data-entry.html" class="btn btn-sm btn-primary">Upload invoices, POS reports, or record waste</a><p class="fs-13 text-muted mt-2 mb-0">Manual Data Entry</p></td></tr>';
                        }
                        if (showingEl) showingEl.textContent = `Showing ${rows.length} entr${rows.length === 1 ? 'y' : 'ies'}`;
                    }
                } catch (error) {
                    console.warn('Error loading recent captures:', error);
                    const tbody = document.getElementById('cost-transactions-table-body');
                    if (tbody) tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4"><div class="text-muted mb-2">No captured data yet.</div><a href="manual-data-entry.html" class="btn btn-sm btn-primary">Upload invoices, POS reports, or record waste</a><p class="fs-13 text-muted mt-2 mb-0">Manual Data Entry</p></td></tr>';
                }
            })();

            // Recently Captured Data collapse: rotate chevron
            (function() {
                const collapseEl = document.getElementById('recently-captured-data-collapse');
                const chevronEl = document.getElementById('recently-captured-data-chevron');
                if (collapseEl && chevronEl) {
                    collapseEl.addEventListener('show.bs.collapse', function() { chevronEl.style.transform = 'rotate(0deg)'; });
                    collapseEl.addEventListener('hide.bs.collapse', function() { chevronEl.style.transform = 'rotate(-90deg)'; });
                }
            })();

            // Load and display savings breakdown when button is clicked or modal opens
            async function loadSavingsBreakdown() {
                const modalBody = document.getElementById('savings-breakdown-content');
                if (!modalBody) {
                    console.error('Modal body not found');
                    return;
                }
                
                // Show loading state
                modalBody.innerHTML = `
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading breakdown...</p>
                    </div>
                `;
                
                try {
                    const period = window.currentDashboardPeriod || 'weekly';
                    const metricsResponse = await window.apiService.getDashboardMetrics(period);
                    const metrics = metricsResponse.data || metricsResponse;
                    
                        console.log('Metrics response:', metrics); // Debug log
                        
                        if (metrics && metrics.savingsBreakdown) {
                            const breakdown = metrics.savingsBreakdown;
                            // One number everywhere: use gross P&L when available (Sales − Food − Labor − Waste)
                            const unifiedLoss = (metrics.isProfitable === false && (metrics.grossProfit != null || metrics.monthlyLoss != null))
                                ? Math.abs(metrics.grossProfit ?? metrics.monthlyLoss ?? 0) : (breakdown.totalPotentialSavings ?? 0);
                            if (modalBody) {
                            const isLoss = breakdown.isLoss === true;
                            const savVal = unifiedLoss;
                            const periodInfo = metrics.periodInfo || {};
                            const periodLine = (periodInfo.monthStart && periodInfo.monthPeriodLabel)
                                ? '<p class="small text-muted mb-3"><strong>Data period:</strong> ' + periodInfo.monthStart + (periodInfo.monthEnd && periodInfo.monthEnd !== periodInfo.monthStart ? ' – ' + periodInfo.monthEnd : '') + ' (' + periodInfo.monthPeriodLabel + ')</p>'
                                : '';
                            var modalTitleEl = document.getElementById('savingsBreakdownModalLabel');
                            if (modalTitleEl) modalTitleEl.innerHTML = '<i class="material-symbols-outlined me-2">savings</i> Savings Breakdown' + (periodInfo.monthPeriodLabel ? ' (' + periodInfo.monthPeriodLabel + ')' : '');
                            const lossFormulaNote = (metrics.grossProfit != null || metrics.monthlyLoss != null) ? '<p class="small text-muted mb-2">Actual loss = Sales − (Food + Labor + Waste). Same as Gross P&L above.</p>' : '';
                            let html = `
                                ${periodLine}
                                ${lossFormulaNote}
                                <div class="mb-4">
                                    <h5 class="mb-3">${isLoss ? 'Actual loss this period:' : 'Under target — no loss to fix'} <span class="fw-bold ${isLoss ? 'text-danger' : 'text-muted'}">${isLoss ? '-$' + savVal.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '—'}</span></h5>
                                    <div class="row mb-3">
                                        <div class="col-md-3">
                                            <div class="text-center p-3 bg-danger bg-opacity-10 rounded">
                                                <div class="fs-24 fw-bold text-danger">${breakdown.summary?.wasteIssues || 0}</div>
                                                <div class="fs-12 text-muted">Waste Issues</div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="text-center p-3 bg-warning bg-opacity-10 rounded">
                                                <div class="fs-24 fw-bold text-warning">${breakdown.summary?.foodCostIssues || 0}</div>
                                                <div class="fs-12 text-muted">Food Cost Issues</div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="text-center p-3 bg-info bg-opacity-10 rounded">
                                                <div class="fs-24 fw-bold text-info">${breakdown.summary?.varianceIssues || 0}</div>
                                                <div class="fs-12 text-muted">Variance Issues</div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="text-center p-3 bg-secondary bg-opacity-10 rounded">
                                                <div class="fs-24 fw-bold text-secondary">${breakdown.summary?.inventoryIssues || 0}</div>
                                                <div class="fs-12 text-muted">Inventory Issues</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <hr>
                            `;
                            
                            // Always show calculation breakdown first (before list-group)
                            const calc = breakdown.calculation;
                            if (calc) {
                                console.log('Building calculation HTML...'); // Debug log
                                
                                // Step-by-step calculation
                                let stepsHtml = '';
                                if (calc.stepByStep && calc.stepByStep.length > 0) {
                                    stepsHtml = calc.stepByStep.map(step => {
                                        const isLossStep = step.step === 3 && step.isLoss;
                                        const isProfitStep = step.step === 3 && step.isLoss === false;
                                        const stepBorder = isLossStep ? 'border-danger' : (isProfitStep ? 'border-success' : (step.step === 4 && step.isLoss === false ? 'border-success' : (step.step === 4 && step.isLoss ? 'border-danger' : 'border-primary')));
                                        const stepColor = isLossStep ? 'text-danger' : (isProfitStep ? 'text-success' : (step.step === 4 && step.isLoss === false ? 'text-success' : (step.step === 4 && step.isLoss ? 'text-danger' : 'text-primary')));
                                        const stepVal = step.value;
                                        const isPctStep = step.step === 4 || step.step === 5 || step.step === 6;
                                        const stepValStr = (stepVal == null || typeof stepVal !== 'number') ? '—' : (isPctStep ? stepVal.toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 1}) + '%' : (stepVal < 0 ? '-$' + Math.abs(stepVal).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '$' + stepVal.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})));
                                        return `
                                        <div class="card mb-2 border-start border-3 ${stepBorder}">
                                            <div class="card-body">
                                                <div class="d-flex align-items-start">
                                                    <div class="flex-shrink-0 me-3">
                                                        <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px; font-weight: bold;">${step.step}</div>
                                                    </div>
                                                    <div class="flex-grow-1">
                                                        <h6 class="mb-1">${step.title}</h6>
                                                        <div class="fs-18 fw-bold ${stepColor} mb-1">${stepValStr}</div>
                                                        <p class="small text-muted mb-1">${step.description}</p>
                                                        ${step.formula ? `<code class="small ${step.isLoss === false ? 'text-success' : (step.isLoss ? 'text-danger' : 'text-success')} d-block mt-1">${step.formula}</code>` : ''}
                                                        ${step.count !== undefined ? `<span class="badge bg-light text-dark ms-2">${step.count} records</span>` : ''}
                                                        ${step.source ? `<span class="badge bg-info ms-2">Source: ${step.source}</span>` : ''}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                    }).join('');
                                }
                                
                                // Purchases breakdown
                                let purchasesHtml = '';
                                if (calc.purchases && calc.purchases.length > 0) {
                                    purchasesHtml = `
                                        <div class="mt-4">
                                            <h6 class="mb-2"><i class="material-symbols-outlined me-2 fs-18">shopping_cart</i>Individual Purchases (${calc.purchases.length} total) - These sum to Total Purchases</h6>
                                            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                                <table class="table table-sm table-hover table-bordered">
                                                    <thead class="table-light sticky-top">
                                                        <tr>
                                                            <th>Date</th>
                                                            <th>Vendor</th>
                                                            <th class="text-end">Amount</th>
                                                            <th>Invoice #</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        ${calc.purchases.map(p => `
                                                            <tr>
                                                                <td>${new Date(p.date).toLocaleDateString()}</td>
                                                                <td>${p.vendor}</td>
                                                                <td class="text-end">$${p.amount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                                                <td class="small text-muted">${p.invoice}</td>
                                                            </tr>
                                                        `).join('')}
                                                    </tbody>
                                                    <tfoot class="table-light fw-bold">
                                                        <tr>
                                                            <td colspan="2" class="text-end">Total Purchases:</td>
                                                            <td class="text-end">$${calc.totalPurchases.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                                            <td></td>
                                                        </tr>
                                                    </tfoot>
                                                </table>
                                            </div>
                                        </div>
                                    `;
                                }
                                
                                // Sales breakdown
                                let salesHtml = '';
                                if (calc.sales && calc.sales.length > 0) {
                                    salesHtml = `
                                        <div class="mt-4">
                                            <h6 class="mb-2"><i class="material-symbols-outlined me-2 fs-18">point_of_sale</i>Individual Sales (${calc.sales.length} total) - These sum to Total Sales</h6>
                                            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                                <table class="table table-sm table-hover table-bordered">
                                                    <thead class="table-light sticky-top">
                                                        <tr>
                                                            <th>Date</th>
                                                            <th class="text-end">Amount</th>
                                                            <th>Source</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        ${calc.sales.map(s => `
                                                            <tr>
                                                                <td>${new Date(s.date).toLocaleDateString()}</td>
                                                                <td class="text-end">$${s.amount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                                                <td><span class="badge bg-success">${s.source}</span></td>
                                                            </tr>
                                                        `).join('')}
                                                    </tbody>
                                                    <tfoot class="table-light fw-bold">
                                                        <tr>
                                                            <td class="text-end">Total Sales:</td>
                                                            <td class="text-end">$${calc.totalSales.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                                            <td></td>
                                                        </tr>
                                                    </tfoot>
                                                </table>
                                            </div>
                                        </div>
                                    `;
                                }
                                
                                html += `
                                    <div class="card mb-4">
                                        <div class="card-header bg-primary text-white">
                                            <h6 class="mb-0"><i class="material-symbols-outlined me-2">calculate</i>Calculation Breakdown - Where the Numbers Come From</h6>
                                        </div>
                                        <div class="card-body">
                                            <h6 class="mb-3">Step-by-Step Calculation:</h6>
                                            ${stepsHtml}
                                            
                                            <hr class="my-4">
                                            
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <div class="card bg-light">
                                                        <div class="card-body">
                                                            <h6 class="text-muted mb-3">Summary</h6>
                                                            <div class="mb-2">
                                                                <span class="text-muted small d-block">Total Sales:</span>
                                                                <strong class="fs-16">$${(calc.totalSales ?? 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong>
                                                            </div>
                                                            ${calc.grossProfitLoss != null ? `
                                                            <div class="mb-2">
                                                                <span class="text-muted small d-block">Total Costs (Food + Labor + Waste):</span>
                                                                <strong class="fs-16">$${(calc.totalCosts ?? 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong>
                                                            </div>
                                                            <hr>
                                                            <div>
                                                                <span class="text-muted small d-block">${calc.label || 'Gross P&L'}:</span>
                                                                <strong class="fs-20 ${calc.isLoss ? 'text-danger' : 'text-success'}">${(calc.grossProfitLoss != null && calc.grossProfitLoss < 0 ? '-' : '')}$${Math.abs(calc.grossProfitLoss ?? 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong>
                                                            </div>
                                                            ` : `
                                                            <div class="mb-2">
                                                                <span class="text-muted small d-block">Expected Purchases (28%):</span>
                                                                <strong class="fs-16 text-info">$${(calc.expectedPurchases ?? 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong>
                                                            </div>
                                                            <div class="mb-2">
                                                                <span class="text-muted small d-block">Actual Purchases:</span>
                                                                <strong class="fs-16">$${(calc.totalPurchases ?? 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong>
                                                            </div>
                                                            <hr>
                                                            <div>
                                                                <span class="text-muted small d-block">${calc.label || 'Period Loss'}:</span>
                                                                <strong class="fs-20 ${calc.isLoss ? 'text-danger' : 'text-success'}">$${Math.abs(calc.difference ?? 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong>
                                                            </div>
                                                            `}
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="card bg-light">
                                                        <div class="card-body">
                                                            <h6 class="text-muted mb-3">Metrics</h6>
                                                            ${calc.grossProfitLoss != null ? `
                                                            <div class="mb-2">
                                                                <span class="text-muted small d-block">Food Cost %:</span>
                                                                <strong class="fs-16 ${(calc.foodCostPercent ?? 0) > 28 ? 'text-danger' : 'text-success'}">${(calc.foodCostPercent ?? 0).toFixed(1)}%</strong>
                                                            </div>
                                                            <div class="mb-2">
                                                                <span class="text-muted small d-block">Labor Cost %:</span>
                                                                <strong class="fs-16">${(calc.laborCostPercent ?? 0).toFixed(1)}%</strong>
                                                            </div>
                                                            <div class="mb-2">
                                                                <span class="text-muted small d-block">Waste % of Food Cost:</span>
                                                                <strong class="fs-16 ${(calc.wastePercentOfFoodCost ?? 0) > 5 ? 'text-danger' : 'text-success'}">${(calc.wastePercentOfFoodCost ?? 0).toFixed(0)}%</strong>
                                                            </div>
                                                            <hr>
                                                            <div>
                                                                <span class="text-muted small d-block">Gross P&L:</span>
                                                                <strong class="fs-16 ${calc.isLoss ? 'text-danger' : 'text-success'}">${(calc.grossProfitLoss != null && calc.grossProfitLoss < 0 ? '-' : '')}$${Math.abs(calc.grossProfitLoss ?? 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong>
                                                            </div>
                                                            ` : `
                                                            <div class="mb-2">
                                                                <span class="text-muted small d-block">Target Margin:</span>
                                                                <strong class="fs-16">${calc.targetMargin ?? 72}%</strong>
                                                            </div>
                                                            <div class="mb-2">
                                                                <span class="text-muted small d-block">Target Food Cost:</span>
                                                                <strong class="fs-16">28%</strong>
                                                            </div>
                                                            <div class="mb-2">
                                                                <span class="text-muted small d-block">Actual Food Cost:</span>
                                                                <strong class="fs-16 ${(calc.actualFoodCost ?? 0) > 28 ? 'text-danger' : 'text-success'}">${(calc.actualFoodCost ?? 0).toFixed(2)}%</strong>
                                                            </div>
                                                            <hr>
                                                            <div>
                                                                <span class="text-muted small d-block">${calc.isLoss ? 'Difference (Actual − Expected):' : 'Period Gain / Savings:'}</span>
                                                                <strong class="fs-16 ${calc.isLoss ? 'text-danger' : 'text-success'}">${calc.isLoss ? (calc.difference != null && calc.difference < 0 ? '-' : '') + '$' + Math.abs(calc.difference ?? 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '$' + Math.abs(calc.difference ?? 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong>
                                                            </div>
                                                            `}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            ${purchasesHtml}
                                            ${salesHtml}
                                        </div>
                                    </div>
                                `;
                            } else {
                                // Fallback: Calculate from available metrics data
                                console.warn('Calculation object missing, calculating from metrics');
                                const monthlyLoss = metrics.monthlyLoss || metrics.ifFixedMonthlySavings || breakdown.totalPotentialSavings || 0;
                                
                                // Try to get sales and purchases from food cost calculation
                                // We need to make an API call to get food cost data
                                try {
                                    const today = new Date();
                                    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                                    const startDate = monthStart.toISOString().split('T')[0];
                                    const endDate = today.toISOString().split('T')[0];
                                    
                                    // Get food cost data which includes purchases and sales
                                    const foodCostResponse = await fetch(`${window.apiService.API_BASE_URL || 'http://localhost:8000/api'}/analytics/food-cost?startDate=${startDate}&endDate=${endDate}`, {
                                        headers: {
                                            'Authorization': `Bearer ${window.authService?.getToken() || ''}`,
                                            'Content-Type': 'application/json'
                                        }
                                    });
                                    
                                    if (foodCostResponse.ok) {
                                        const foodCostData = await foodCostResponse.json();
                                        const fcData = foodCostData.data || foodCostData;
                                        const totalSales = fcData.totalSales || 0;
                                        const totalPurchases = fcData.totalPurchases || 0;
                                        const expectedPurchases = totalSales * 0.28;
                                        const diff = totalPurchases - expectedPurchases;
                                        const fallbackIsLoss = diff > 0;
                                        const fallbackLabel = fallbackIsLoss ? 'Period Loss' : 'Period Gain';
                                        const fallbackAbsDiff = Math.abs(diff);
                                        const actualFoodCost = fcData.foodCost || 0;
                                        
                                        html += `
                                            <div class="card mb-4">
                                                <div class="card-header bg-primary text-white">
                                                    <h6 class="mb-0"><i class="material-symbols-outlined me-2">calculate</i>Calculation Breakdown - Where the Numbers Come From</h6>
                                                </div>
                                                <div class="card-body">
                                                    <h6 class="mb-3">Step-by-Step Calculation:</h6>
                                                    <div class="card mb-2 border-start border-3 border-primary">
                                                        <div class="card-body">
                                                            <div class="d-flex align-items-start">
                                                                <div class="flex-shrink-0 me-3">
                                                                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px; font-weight: bold;">1</div>
                                                                </div>
                                                                <div class="flex-grow-1">
                                                                    <h6 class="mb-1">Total Sales</h6>
                                                                    <div class="fs-18 fw-bold text-primary mb-1">$${totalSales.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                                                    <p class="small text-muted mb-1">Sum of all sales records this month</p>
                                                                    <span class="badge bg-info">Source: sales table</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="card mb-2 border-start border-3 border-info">
                                                        <div class="card-body">
                                                            <div class="d-flex align-items-start">
                                                                <div class="flex-shrink-0 me-3">
                                                                    <div class="bg-info text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px; font-weight: bold;">2</div>
                                                                </div>
                                                                <div class="flex-grow-1">
                                                                    <h6 class="mb-1">Target Food Cost (28%)</h6>
                                                                    <div class="fs-18 fw-bold text-info mb-1">$${expectedPurchases.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                                                    <p class="small text-muted mb-1">Expected purchases (industry standard for full-service restaurants)</p>
                                                                    <code class="small text-success d-block mt-1">$${totalSales.toLocaleString()} × 0.28 = $${expectedPurchases.toLocaleString()}</code>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="card mb-2 border-start border-3 border-warning">
                                                        <div class="card-body">
                                                            <div class="d-flex align-items-start">
                                                                <div class="flex-shrink-0 me-3">
                                                                    <div class="bg-warning text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px; font-weight: bold;">3</div>
                                                                </div>
                                                                <div class="flex-grow-1">
                                                                    <h6 class="mb-1">Actual Purchases</h6>
                                                                    <div class="fs-18 fw-bold text-warning mb-1">$${totalPurchases.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                                                    <p class="small text-muted mb-1">Sum of all purchase records this month</p>
                                                                    <span class="badge bg-info">Source: purchases table</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="card mb-2 border-start border-3 ${fallbackIsLoss ? 'border-danger' : 'border-success'}">
                                                        <div class="card-body">
                                                            <div class="d-flex align-items-start">
                                                                <div class="flex-shrink-0 me-3">
                                                                    <div class="${fallbackIsLoss ? 'bg-danger' : 'bg-success'} text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px; font-weight: bold;">4</div>
                                                                </div>
                                                                <div class="flex-grow-1">
                                                                    <h6 class="mb-1">${fallbackLabel}</h6>
                                                                    <div class="fs-18 fw-bold ${fallbackIsLoss ? 'text-danger' : 'text-success'} mb-1">$${Math.abs(diff).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                                                    <p class="small text-muted mb-1">${fallbackIsLoss ? 'Actual > target → over-spend (loss).' : 'Actual < target → under target (gain).'}</p>
                                                                    <code class="small ${fallbackIsLoss ? 'text-danger' : 'text-success'} d-block mt-1">${fallbackIsLoss ? `$${totalPurchases.toLocaleString()} − $${expectedPurchases.toLocaleString()} = $${diff.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}` : `$${expectedPurchases.toLocaleString()} − $${totalPurchases.toLocaleString()} = $${fallbackAbsDiff.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} (gain)`}</code>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <hr class="my-4">
                                                    
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="card bg-light">
                                                                <div class="card-body">
                                                                    <h6 class="text-muted mb-3">Summary</h6>
                                                                    <div class="mb-2">
                                                                        <span class="text-muted small d-block">Total Sales:</span>
                                                                        <strong class="fs-16">$${totalSales.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong>
                                                                    </div>
                                                                    <div class="mb-2">
                                                                        <span class="text-muted small d-block">Expected Purchases (28%):</span>
                                                                        <strong class="fs-16 text-info">$${expectedPurchases.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong>
                                                                    </div>
                                                                    <div class="mb-2">
                                                                        <span class="text-muted small d-block">Actual Purchases:</span>
                                                                        <strong class="fs-16">$${totalPurchases.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong>
                                                                    </div>
                                                                    <hr>
                                                                    <div>
                                                                        <span class="text-muted small d-block">${fallbackLabel}:</span>
                                                                        <strong class="fs-20 ${fallbackIsLoss ? 'text-danger' : 'text-success'}">$${Math.abs(diff).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="card bg-light">
                                                                <div class="card-body">
                                                                    <h6 class="text-muted mb-3">Metrics</h6>
                                                                    <div class="mb-2">
                                                                        <span class="text-muted small d-block">Target Margin:</span>
                                                                        <strong class="fs-16">72%</strong>
                                                                    </div>
                                                                    <div class="mb-2">
                                                                        <span class="text-muted small d-block">Target Food Cost:</span>
                                                                        <strong class="fs-16">35%</strong>
                                                                    </div>
                                                                    <div class="mb-2">
                                                                        <span class="text-muted small d-block">Actual Food Cost:</span>
                                                                        <strong class="fs-16 ${actualFoodCost > 28 ? 'text-danger' : 'text-success'}">${actualFoodCost.toFixed(2)}%</strong>
                                                                    </div>
                                                                    <hr>
                                                                    <div>
                                                                        <span class="text-muted small d-block">${fallbackIsLoss ? 'Difference (Actual − Expected):' : 'Period Gain / Savings:'}</span>
                                                                        <strong class="fs-16 ${fallbackIsLoss ? 'text-danger' : 'text-success'}">${fallbackIsLoss ? '$' + diff.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '$' + Math.abs(diff).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    } else {
                                        throw new Error('Failed to fetch food cost data');
                                    }
                                } catch (error) {
                                    console.error('Error fetching food cost data:', error);
                                    const ulLabel = monthlyIsLossFallback ? 'Period Loss' : 'Period Gain';
                                    html += `
                                        <div class="card mb-4">
                                            <div class="card-header bg-primary text-white">
                                                <h6 class="mb-0"><i class="material-symbols-outlined me-2">calculate</i>Calculation Breakdown</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="alert alert-warning">
                                                    <small>Unable to load detailed calculation. ${ulLabel}: <strong>$${Math.abs(monthlyLossAmt).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong></small>
                                                </div>
                                                <p class="text-muted small">${ulLabel} = Actual Purchases − (Sales × 28%). Over target = loss, under = gain.</p>
                                            </div>
                                        </div>
                                    `;
                                }
                            }
                            
                            // Show specific issues if any
                            html += '<hr><h6 class="mb-3">Detailed Breakdown:</h6><div class="list-group">';
                            if (breakdown.items && breakdown.items.length > 0) {
                                breakdown.items.forEach((item, index) => {
                                    const priorityColor = item.priority === 'High' ? 'danger' : item.priority === 'Medium' ? 'warning' : 'secondary';
                                    const categoryIcon = item.category === 'Waste' ? 'delete' : item.category === 'Food Cost' ? 'restaurant' : item.category === 'Variance' ? 'compare_arrows' : 'inventory';
                                    
                                    html += `
                                        <div class="list-group-item mb-3 border rounded">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <div class="flex-grow-1">
                                                    <div class="d-flex align-items-center gap-2 mb-2">
                                                        <span class="badge bg-${priorityColor}">${item.priority}</span>
                                                        <span class="badge bg-light text-dark">${item.category}</span>
                                                        <i class="material-symbols-outlined fs-18">${categoryIcon}</i>
                                                    </div>
                                                    <h6 class="mb-1">${item.issue}</h6>
                                                    <p class="text-muted mb-2 fs-14">${item.recommendation}</p>
                                                </div>
                                                <div class="text-end">
                                                    <div class="fs-18 fw-bold text-danger">$${item.monthlyImpact.toLocaleString()}</div>
                                                    <div class="fs-12 text-muted">Period Impact</div>
                                                </div>
                                            </div>
                                            <div class="mt-2">
                                                <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#actionItems${index}" aria-expanded="false">
                                                    <i class="material-symbols-outlined fs-14">expand_more</i> View Action Items
                                                </button>
                                                <div class="collapse mt-2" id="actionItems${index}">
                                                    <div class="card card-body bg-light">
                                                        <ul class="mb-0 ps-3">
                                                            ${item.actionItems.map(action => `<li class="mb-1">${action}</li>`).join('')}
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                });
                            } else {
                                html += '<div class="alert alert-info mt-3"><i class="material-symbols-outlined me-2">info</i>No specific issues identified. Your cost control is within target ranges.</div>';
                            }
                            
                            html += '</div>';
                            modalBody.innerHTML = html;
                        } else {
                            modalBody.innerHTML = '<div class="alert alert-warning">Breakdown data not available in metrics response.</div>';
                        }
                    } else {
                        // No breakdown available - show calculation details
                        const calculation = metrics.savingsBreakdown?.calculation;
                        const monthlyLossAmount = metrics.monthlyLoss || metrics.ifFixedMonthlySavings || 0;
                        
                        console.log('No items found, showing calculation:', calculation); // Debug log
                        console.log('Full breakdown:', metrics.savingsBreakdown); // Debug log
                        
                        let calculationHtml = '';
                        
                        // Always show calculation if breakdown exists, even if stepByStep is missing
                        if (calculation) {
                            // Step-by-step calculation
                            let stepsHtml = '';
                            
                            // If stepByStep exists, use it; otherwise create it from available data
                            if (calculation.stepByStep && calculation.stepByStep.length > 0) {
                                stepsHtml = calculation.stepByStep.map(step => {
                                    const stepVal = step.value;
                                    const isPctStep = step.step === 4 || step.step === 5 || step.step === 6;
                                    const stepValStr = (stepVal == null || typeof stepVal !== 'number') ? '—' : (isPctStep ? stepVal.toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 1}) + '%' : (stepVal < 0 ? '-$' + Math.abs(stepVal).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '$' + stepVal.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})));
                                    const stepColor = step.step === 3 && step.isLoss ? 'text-danger' : (step.step === 3 && !step.isLoss ? 'text-success' : 'text-primary');
                                    return `
                                    <div class="card mb-2 border-start border-3 ${step.step === 3 && step.isLoss ? 'border-danger' : (step.step === 3 ? 'border-success' : 'border-primary')}">
                                        <div class="card-body">
                                            <div class="d-flex align-items-start">
                                                <div class="flex-shrink-0 me-3">
                                                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px; font-weight: bold;">${step.step}</div>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-1">${step.title}</h6>
                                                    <div class="fs-18 fw-bold ${stepColor} mb-1">${stepValStr}</div>
                                                    <p class="small text-muted mb-1">${step.description}</p>
                                                    ${step.formula ? `<code class="small text-success">${step.formula}</code>` : ''}
                                                    ${step.count !== undefined ? `<span class="badge bg-light text-dark ms-2">${step.count} records</span>` : ''}
                                                    ${step.source ? `<span class="badge bg-info ms-2">Source: ${step.source}</span>` : ''}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                                }).join('');
                            } else if (calculation.grossProfitLoss != null) {
                                // New P&L shape: use totalCosts and grossProfitLoss (no expectedPurchases/difference)
                                const totalSales = calculation.totalSales ?? 0;
                                const totalCosts = calculation.totalCosts ?? 0;
                                const grossLoss = calculation.grossProfitLoss;
                                stepsHtml = `
                                    <div class="card mb-2 border-start border-3 border-primary">
                                        <div class="card-body">
                                            <div class="d-flex align-items-start">
                                                <div class="flex-shrink-0 me-3"><div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px; font-weight: bold;">1</div></div>
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-1">Total Sales</h6>
                                                    <div class="fs-18 fw-bold text-primary mb-1">$${totalSales.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                                    <p class="small text-muted mb-1">Sum of all sales records</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card mb-2 border-start border-3 border-info">
                                        <div class="card-body">
                                            <div class="d-flex align-items-start">
                                                <div class="flex-shrink-0 me-3"><div class="bg-info text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px; font-weight: bold;">2</div></div>
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-1">Total Costs (Food + Labor + Waste)</h6>
                                                    <div class="fs-18 fw-bold text-info mb-1">$${totalCosts.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                                    <p class="small text-muted mb-1">Food + Labor + Waste</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card mb-2 border-start border-3 ${calculation.isLoss ? 'border-danger' : 'border-success'}">
                                        <div class="card-body">
                                            <div class="d-flex align-items-start">
                                                <div class="flex-shrink-0 me-3"><div class="${calculation.isLoss ? 'bg-danger' : 'bg-success'} text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px; font-weight: bold;">3</div></div>
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-1">Gross Profit / Loss</h6>
                                                    <div class="fs-18 fw-bold ${calculation.isLoss ? 'text-danger' : 'text-success'} mb-1">${grossLoss < 0 ? '-' : ''}$${Math.abs(grossLoss).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                                    <p class="small text-muted mb-1">${calculation.isLoss ? 'Sales − Costs = loss.' : 'Sales − Costs = profit.'}</p>
                                                    <code class="small ${calculation.isLoss ? 'text-danger' : 'text-success'}">$${totalSales.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} − $${totalCosts.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} = ${grossLoss < 0 ? '-' : ''}$${Math.abs(grossLoss).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</code>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            } else {
                                // Fallback: legacy 4-step (Expected Purchases, Difference)
                                const expectedPurchases = calculation.expectedPurchases ?? (calculation.totalSales ?? 0) * 0.28;
                                const totalSales = calculation.totalSales ?? 0;
                                const totalPurchases = calculation.totalPurchases ?? 0;
                                const diff = calculation.difference ?? 0;
                                stepsHtml = `
                                    <div class="card mb-2 border-start border-3 border-primary">
                                        <div class="card-body">
                                            <div class="d-flex align-items-start">
                                                <div class="flex-shrink-0 me-3"><div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px; font-weight: bold;">1</div></div>
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-1">Total Sales</h6>
                                                    <div class="fs-18 fw-bold text-primary mb-1">$${totalSales.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                                    <p class="small text-muted mb-1">Sum of all sales records</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card mb-2 border-start border-3 border-info">
                                        <div class="card-body">
                                            <div class="d-flex align-items-start">
                                                <div class="flex-shrink-0 me-3"><div class="bg-info text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px; font-weight: bold;">2</div></div>
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-1">Target Food Cost (28%)</h6>
                                                    <div class="fs-18 fw-bold text-info mb-1">$${expectedPurchases.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                                    <p class="small text-muted mb-1">Expected purchases (industry standard)</p>
                                                    <code class="small text-success">$${totalSales.toLocaleString()} × 0.28 = $${expectedPurchases.toLocaleString()}</code>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card mb-2 border-start border-3 border-warning">
                                        <div class="card-body">
                                            <div class="d-flex align-items-start">
                                                <div class="flex-shrink-0 me-3"><div class="bg-warning text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px; font-weight: bold;">3</div></div>
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-1">Actual Purchases</h6>
                                                    <div class="fs-18 fw-bold text-warning mb-1">$${totalPurchases.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                                    <p class="small text-muted mb-1">Sum of all purchase records</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card mb-2 border-start border-3 ${calculation.isLoss ? 'border-danger' : 'border-success'}">
                                        <div class="card-body">
                                            <div class="d-flex align-items-start">
                                                <div class="flex-shrink-0 me-3"><div class="${calculation.isLoss ? 'bg-danger' : 'bg-success'} text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px; font-weight: bold;">4</div></div>
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-1">${calculation.label || 'Period Loss'}</h6>
                                                    <div class="fs-18 fw-bold ${calculation.isLoss ? 'text-danger' : 'text-success'} mb-1">$${Math.abs(diff).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                                    <p class="small text-muted mb-1">${calculation.isLoss ? 'Actual > target → over-spend (loss).' : 'Under target (gain).'}</p>
                                                    <code class="small ${calculation.isLoss ? 'text-danger' : 'text-success'}">$${totalPurchases.toLocaleString()} − $${expectedPurchases.toLocaleString()} = $${diff.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</code>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }
                            
                            // Purchases breakdown
                            let purchasesHtml = '';
                            if (calculation.purchases && calculation.purchases.length > 0) {
                                const topPurchases = calculation.purchases.slice(0, 10);
                                purchasesHtml = `
                                    <div class="mt-3">
                                        <h6 class="mb-2"><i class="material-symbols-outlined me-2 fs-18">shopping_cart</i>Purchase Details (${calculation.purchases.length} total)</h6>
                                        <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                                            <table class="table table-sm table-hover">
                                                <thead class="table-light sticky-top">
                                                    <tr>
                                                        <th>Date</th>
                                                        <th>Vendor</th>
                                                        <th class="text-end">Amount</th>
                                                        <th>Invoice</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${topPurchases.map(p => `
                                                        <tr>
                                                            <td>${new Date(p.date).toLocaleDateString()}</td>
                                                            <td>${p.vendor}</td>
                                                            <td class="text-end">$${p.amount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                                            <td class="small text-muted">${p.invoice}</td>
                                                        </tr>
                                                    `).join('')}
                                                </tbody>
                                                <tfoot class="table-light">
                                                    <tr>
                                                        <td colspan="2" class="fw-bold">Total Purchases:</td>
                                                        <td class="text-end fw-bold">$${calculation.totalPurchases.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                                        <td></td>
                                                    </tr>
                                                </tfoot>
                                            </table>
                                        </div>
                                        ${calculation.purchases.length > 10 ? `<p class="small text-muted mt-2">Showing top 10 of ${calculation.purchases.length} purchases</p>` : ''}
                                    </div>
                                `;
                            }
                            
                            // Sales breakdown
                            let salesHtml = '';
                            if (calculation.sales && calculation.sales.length > 0) {
                                const topSales = calculation.sales.slice(0, 10);
                                salesHtml = `
                                    <div class="mt-3">
                                        <h6 class="mb-2"><i class="material-symbols-outlined me-2 fs-18">point_of_sale</i>Sales Details (${calculation.sales.length} total)</h6>
                                        <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                                            <table class="table table-sm table-hover">
                                                <thead class="table-light sticky-top">
                                                    <tr>
                                                        <th>Date</th>
                                                        <th class="text-end">Amount</th>
                                                        <th>Source</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${topSales.map(s => `
                                                        <tr>
                                                            <td>${new Date(s.date).toLocaleDateString()}</td>
                                                            <td class="text-end">$${s.amount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                                            <td><span class="badge bg-success">${s.source}</span></td>
                                                        </tr>
                                                    `).join('')}
                                                </tbody>
                                                <tfoot class="table-light">
                                                    <tr>
                                                        <td class="fw-bold">Total Sales:</td>
                                                        <td class="text-end fw-bold">$${calculation.totalSales.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                                        <td></td>
                                                    </tr>
                                                </tfoot>
                                            </table>
                                        </div>
                                        ${calculation.sales.length > 10 ? `<p class="small text-muted mt-2">Showing top 10 of ${calculation.sales.length} sales records</p>` : ''}
                                    </div>
                                `;
                            }
                            
                            calculationHtml = `
                                <div class="card mb-3">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0"><i class="material-symbols-outlined me-2">calculate</i>Detailed Calculation — ${calculation.label || 'Period Loss'}</h6>
                                    </div>
                                    <div class="card-body">
                                        <h6 class="mb-3">Step-by-Step Calculation:</h6>
                                        ${stepsHtml}
                                        
                                        <hr class="my-4">
                                        
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="card bg-light">
                                                    <div class="card-body">
                                                        <h6 class="text-muted mb-2">Summary</h6>
                                                        <div class="mb-2">
                                                            <span class="text-muted small d-block">Total Sales:</span>
                                                            <strong class="fs-16">$${(calculation.totalSales ?? 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong>
                                                        </div>
                                                        ${calculation.grossProfitLoss != null ? `
                                                        <div class="mb-2">
                                                            <span class="text-muted small d-block">Total Costs:</span>
                                                            <strong class="fs-16">$${(calculation.totalCosts ?? 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong>
                                                        </div>
                                                        <hr>
                                                        <div>
                                                            <span class="text-muted small d-block">${calculation.label || 'Gross P&L'}:</span>
                                                            <strong class="fs-20 ${calculation.isLoss ? 'text-danger' : 'text-success'}">${(calculation.grossProfitLoss != null && calculation.grossProfitLoss < 0 ? '-' : '')}$${Math.abs(calculation.grossProfitLoss ?? 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong>
                                                        </div>
                                                        ` : `
                                                        <div class="mb-2">
                                                            <span class="text-muted small d-block">Expected Purchases (28%):</span>
                                                            <strong class="fs-16 text-info">$${(calculation.expectedPurchases ?? 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong>
                                                        </div>
                                                        <div class="mb-2">
                                                            <span class="text-muted small d-block">Actual Purchases:</span>
                                                            <strong class="fs-16">$${(calculation.totalPurchases ?? 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong>
                                                        </div>
                                                        <hr>
                                                        <div>
                                                            <span class="text-muted small d-block">${calculation.label || 'Period Loss'}:</span>
                                                            <strong class="fs-20 ${calculation.isLoss ? 'text-danger' : 'text-success'}">$${Math.abs(calculation.difference ?? 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong>
                                                        </div>
                                                        `}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="card bg-light">
                                                    <div class="card-body">
                                                        <h6 class="text-muted mb-2">Metrics</h6>
                                                        ${calculation.grossProfitLoss != null ? `
                                                        <div class="mb-2">
                                                            <span class="text-muted small d-block">Food Cost %:</span>
                                                            <strong class="fs-16 ${(calculation.foodCostPercent ?? 0) > 28 ? 'text-danger' : 'text-success'}">${(calculation.foodCostPercent ?? 0).toFixed(1)}%</strong>
                                                        </div>
                                                        <div class="mb-2">
                                                            <span class="text-muted small d-block">Labor Cost %:</span>
                                                            <strong class="fs-16">${(calculation.laborCostPercent ?? 0).toFixed(1)}%</strong>
                                                        </div>
                                                        <div class="mb-2">
                                                            <span class="text-muted small d-block">Waste % of Food Cost:</span>
                                                            <strong class="fs-16">${(calculation.wastePercentOfFoodCost ?? 0).toFixed(0)}%</strong>
                                                        </div>
                                                        <hr>
                                                        <div>
                                                            <span class="text-muted small d-block">Gross P&L:</span>
                                                            <strong class="fs-16 ${calculation.isLoss ? 'text-danger' : 'text-success'}">${(calculation.grossProfitLoss != null && calculation.grossProfitLoss < 0 ? '-' : '')}$${Math.abs(calculation.grossProfitLoss ?? 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong>
                                                        </div>
                                                        ` : `
                                                        <div class="mb-2">
                                                            <span class="text-muted small d-block">Target Margin:</span>
                                                            <strong class="fs-16">${calculation.targetMargin ?? 72}%</strong>
                                                        </div>
                                                        <div class="mb-2">
                                                            <span class="text-muted small d-block">Target Food Cost:</span>
                                                            <strong class="fs-16">28%</strong>
                                                        </div>
                                                        <div class="mb-2">
                                                            <span class="text-muted small d-block">Actual Food Cost:</span>
                                                            <strong class="fs-16 ${(calculation.actualFoodCost ?? 0) > 28 ? 'text-danger' : 'text-success'}">${(calculation.actualFoodCost ?? 0).toFixed(2)}%</strong>
                                                        </div>
                                                        <hr>
                                                        <div>
                                                            <span class="text-muted small d-block">${calculation.isLoss ? 'Difference:' : 'Period Gain:'}</span>
                                                            <strong class="fs-16 ${calculation.isLoss ? 'text-danger' : 'text-success'}">${calculation.isLoss ? (calculation.difference != null && calculation.difference < 0 ? '-' : '') + '$' + Math.abs(calculation.difference ?? 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '$' + Math.abs(calculation.difference ?? 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong>
                                                        </div>
                                                        `}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        ${purchasesHtml}
                                        ${salesHtml}
                                    </div>
                                </div>
                            `;
                        }
                        
                        const noIssuesLabel = (calculation.label || 'Period Loss').toLowerCase();
                        const noIssuesVal = Math.abs(calculation.grossProfitLoss ?? calculation.difference ?? monthlyLossAmount ?? 0);
                        modalBody.innerHTML = `
                            ${calculationHtml}
                            <div class="alert alert-info">
                                <h6><i class="material-symbols-outlined me-2">info</i>No Specific Issues Identified</h6>
                                <p class="mb-2">You have a ${noIssuesLabel} of <strong>$${noIssuesVal.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong>. ${calculation.isLoss ? 'No specific waste, variance, or food cost issues were detected above thresholds.' : 'You\'re under target — no preventable loss to fix.'}</p>
                                <hr>
                                <p class="mb-2 small fw-bold">To identify specific areas for improvement:</p>
                                <ul class="mb-0 small">
                                    <li><strong>Enter waste records</strong> - Track food waste to identify specific items/categories with high waste</li>
                                    <li><strong>Upload purchase invoices</strong> - Ensure all purchases are recorded for accurate cost analysis</li>
                                    <li><strong>Sync sales data</strong> - Keep sales data up to date for accurate margin calculations</li>
                                    <li><strong>Review food cost</strong> - If food cost exceeds 28%, specific recommendations will appear</li>
                                </ul>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('Error loading savings breakdown:', error);
                    modalBody.innerHTML = `
                        <div class="alert alert-danger">
                            <h6>Error loading breakdown</h6>
                            <p class="mb-0">${error.message || 'Unable to load savings breakdown. Please try again later.'}</p>
                        </div>
                    `;
                }
            }
            
            // Set up event listeners (run immediately since script is at end of body)
            (function setupBreakdownLoader() {
                // Button click handler
                const viewBreakdownBtn = document.getElementById('view-breakdown-btn');
                if (viewBreakdownBtn) {
                    viewBreakdownBtn.addEventListener('click', function(e) {
                        // Don't prevent default - let Bootstrap handle modal opening
                        // Load data after a short delay to ensure modal is visible
                        setTimeout(loadSavingsBreakdown, 150);
                    });
                    console.log('✅ Breakdown button listener attached');
                } else {
                    console.warn('⚠️ Breakdown button not found');
                }
                
                // Modal show event (backup)
                const savingsBreakdownModal = document.getElementById('savingsBreakdownModal');
                if (savingsBreakdownModal) {
                    savingsBreakdownModal.addEventListener('show.bs.modal', function() {
                        console.log('Modal show event triggered');
                        loadSavingsBreakdown();
                    });
                    console.log('✅ Modal event listener attached');
                } else {
                    console.warn('⚠️ Modal not found');
                }
            })();

            // Guided Fix: Top Loss Sources → "How to fix" modal
            (function() {
                const GUIDED_FIX = {
                    waste: {
                        title: 'Food Waste',
                        savings: function(amt) { return 'Reducing waste from 8.5% to 5% on your current purchases would save about $' + Math.round(amt * 0.4).toLocaleString() + ' this month.'; },
                        causes: ['Portion sizes too large', 'Improper storage or temps', 'Over-prepping / unused prep', 'Low-selling menu items', 'Spoilage (FIFO not followed)'],
                        steps: ['Conduct a waste track for 3–7 days. Weigh and log everything thrown out (Waste Tracking).', 'Identify the source: spoiled ingredients (storage) vs plate returns (portion) vs trim (prep).', 'Correct storage, refine prep quantities, and review portion sizes.', 'Train staff on FIFO and proper handling.']
                    },
                    labor: {
                        title: 'Labor Inefficiency',
                        savings: function(amt) { return 'Scheduling ~2 fewer hours per day on slow shifts can save ~$' + Math.round(amt / 4).toLocaleString() + '/week. Labor cost ' + (amt > 3000 ? '>$3k' : '$' + amt) + ' this month.'; },
                        causes: ['Overstaffing on slow days', 'Shifts not aligned to sales', 'Lack of cross-training', 'Inefficient scheduling'],
                        steps: ['Use Labor Cost Analysis. Compare sales vs labor hours by day-part.', 'Right-size schedules: adjust start/end times, avoid overstaffing on slow weekdays.', 'Cross-train staff so you can run with fewer people without losing service.']
                    },
                    supplier: {
                        title: 'Supplier Price Variance',
                        savings: function(amt) { return 'This variance cost you about $' + amt.toLocaleString() + ' this month. Negotiate or switch suppliers to recover it.'; },
                        causes: ['Price increases not negotiated', 'No comparison with other suppliers', 'Contract locked at higher rates'],
                        steps: ['Confront the supplier about the increase (Suppliers & Invoices).', 'Get competitive quotes from 2–3 other suppliers.', 'Use the increase as leverage in negotiations.']
                    },
                    shrinkage: {
                        title: 'Inventory Shrinkage',
                        savings: function(amt) { return 'Shrinkage (theft/spoilage/error) is costing ~$' + amt.toLocaleString() + '/month. Weekly counts reduce it.'; },
                        causes: ['No regular inventory counts', 'Theft or unrecorded waste', 'Receiving vs invoice errors', 'Inconsistent portioning'],
                        steps: ['Start weekly inventory counts (Manual Data Entry or mobile count).', 'Reconcile counts to purchases and sales to find variance.', 'Tighten controls: lock storage, verify receiving, track waste.']
                    },
                    menu: {
                        title: 'Low Margin Menu Items',
                        savings: function(amt) { return 'These items cost you ~$' + amt.toLocaleString() + ' in margin. Reprice, reduce cost, or replace.'; },
                        causes: ['Items priced too low', 'High-cost ingredients', 'Poor recipe costing'],
                        steps: ['Open Menu Profitability. Identify the 5 low-margin (<20%) items.', 'For each: raise price, reduce cost (e.g. garnish), or replace with a higher-margin dish.', 'Promote high-margin stars through specials or server incentives.']
                    },
                    foodcost: {
                        title: 'Food Cost %',
                        savings: function(amt) { return 'Getting food cost from 34% down to 28% could save ~$' + amt.toLocaleString() + '/month. Use weekly inventory counts and better portioning.'; },
                        causes: ['No weekly inventory counts', 'Over-portioning', 'Waste or shrinkage', 'Supplier price creep', 'Menu mix shifting to high-cost items'],
                        steps: ['Do weekly inventory counts (Manual Data Entry or mobile). Formula: (Begin + Purchases - End) / Food Sales.', 'Review portion sizes and prep quantities. Reduce over-portioning.', 'Track waste and variance. Use Waste Tracking (Analytics).']
                    }
                };

                function openGuidedFix(el) {
                    var type = el.dataset.lossType;
                    var amount = parseInt(el.dataset.amount, 10) || 0;
                    var link = el.dataset.link || '#';
                    var guide = GUIDED_FIX[type];
                    if (!guide) return;
                    document.getElementById('guided-fix-title').textContent = guide.title;
                    document.getElementById('guided-fix-savings').textContent = guide.savings(amount);
                    document.getElementById('guided-fix-causes').innerHTML = guide.causes.map(function(c) {
                        return '<li class="list-group-item d-flex align-items-center"><span class="form-check-input me-2" style="margin-top:0"></span>' + c + '</li>';
                    }).join('');
                    document.getElementById('guided-fix-steps').innerHTML = guide.steps.map(function(s) {
                        return '<li class="mb-2">' + s + '</li>';
                    }).join('');
                    var a = document.getElementById('guided-fix-link');
                    a.href = link;
                    var linkLabels = { waste: 'Waste Tracking', labor: 'Labor Cost Analysis', supplier: 'Suppliers & Invoices', shrinkage: 'Suppliers & Invoices', menu: 'Menu Profitability', foodcost: 'Analytics' };
                    a.textContent = 'Open ' + (linkLabels[type] || 'Module') + ' →';
                    var modal = new bootstrap.Modal(document.getElementById('guidedFixModal'));
                    modal.show();
                }

                document.addEventListener('click', function(e) {
                    var btn = e.target.closest('.guided-fix-btn');
                    var row = e.target.closest('.guided-fix-row');
                    var actionItem = e.target.closest('.action-item-fix');
                    var tr = btn ? btn.closest('tr') : row;
                    var el = tr || actionItem;
                    if (!el) return;
                    e.preventDefault();
                    openGuidedFix(el);
                });
                document.querySelectorAll('.action-item-fix').forEach(function(li) {
                    li.addEventListener('keydown', function(ev) {
                        if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); openGuidedFix(li); }
                    });
                });
            })();
        </script>

        <!-- Guided Fix Modal (from Top Loss Sources "How to fix") -->
        <div class="modal fade" id="guidedFixModal" tabindex="-1" aria-labelledby="guidedFixModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="guidedFixModalLabel">
                            <i class="material-symbols-outlined me-2">medical_services</i> How to Fix: <span id="guided-fix-title">—</span>
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="guided-fix-body">
                        <div class="alert alert-success">
                            <strong id="guided-fix-savings">—</strong>
                        </div>
                        <h6 class="mb-2">Probable causes (checklist)</h6>
                        <ul class="list-group list-group-flush mb-4" id="guided-fix-causes"></ul>
                        <h6 class="mb-2">Actionable steps</h6>
                        <ol class="mb-0" id="guided-fix-steps"></ol>
                        <div class="mt-4">
                            <a href="#" id="guided-fix-link" class="btn btn-primary">Open module →</a>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Savings Breakdown Modal -->
        <div class="modal fade" id="savingsBreakdownModal" tabindex="-1" aria-labelledby="savingsBreakdownModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="savingsBreakdownModalLabel">
                            <i class="material-symbols-outlined me-2">savings</i> Monthly Savings Breakdown
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="savings-breakdown-content">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">Loading breakdown...</p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>